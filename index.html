<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <title>ChineseClass By Krukong</title> <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
      body { font-family: 'Sarabun', sans-serif; }
      @view-transition { navigation: auto; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
      
      .status-box { transition: all 0.2s; }
      .status-none { background: rgba(51, 65, 85, 0.5); border: 1px dashed #475569; color: #94a3b8; }
      .status-done { background: #064e3b; border: 1px solid #059669; color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); }
      
      .btn-score-active { background-color: #d97706 !important; color: white !important; border-color: #fbbf24 !important; transform: scale(1.05); box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

      #toast-notification { transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s; }
      .toast-show { transform: translate(-50%, 0) !important; opacity: 1 !important; }

      /* Animation for Search Result */
      .fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
 </head>
 <body class="w-full h-full bg-slate-950 text-slate-200">
  <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center">
   <div class="app-wrapper w-full max-w-7xl my-2 md:my-4 mx-2 rounded-2xl bg-slate-900/90 shadow-2xl border border-slate-800 flex flex-col relative overflow-hidden">
    
    <header class="w-full px-6 py-4 border-b border-slate-800 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-slate-900 z-10">
     <div class="flex items-center gap-4">
      <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="School Logo" class="h-14 w-14 object-contain drop-shadow-md bg-white/10 rounded-full p-1 border border-slate-600">
      <div>
        <h1 class="text-2xl font-bold text-white tracking-wide">WNY-Chinese<span class="text-red-500">Class</span> V8</h1>
        <p class="text-slate-400 text-xs">‡∏Ñ‡∏£‡∏π‡∏Å‡∏µ‡∏£‡∏ï‡∏¥ ‡∏õ‡∏£‡∏∞‡∏™‡∏û‡∏û‡∏£‡∏£‡∏±‡∏á‡∏™‡∏µ - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</p>
      </div>
     </div>
     <nav class="inline-flex rounded-full bg-slate-950 p-1 border border-slate-800">
        <button id="tab-btn-admin" onclick="switchMainTab('admin')" class="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all"><i class="fa-solid fa-chalkboard-user mr-2"></i>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button> 
        <button id="tab-btn-student" onclick="switchMainTab('student')" class="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all"><i class="fa-solid fa-user-graduate mr-2"></i>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
     </nav>
    </header>

    <main class="flex-1 w-full px-4 md:px-6 pb-6 overflow-y-auto">
     <div class="w-full max-w-7xl mx-auto mt-6 flex flex-col gap-6">
      
      <div id="section-admin" class="flex flex-col gap-5">
        
        <div id="admin-login-wrapper" class="flex flex-col items-center justify-center py-10 gap-6">
            <div class="glass p-8 rounded-2xl w-full max-w-sm shadow-xl relative flex flex-col items-center border border-slate-700">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-amber-500"></div>
                <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Logo" class="w-20 h-20 object-contain mb-4">
                <h2 class="text-xl font-bold text-white mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
                <form id="admin-login-form" class="space-y-4 w-full">
                    <input id="admin-username" type="text" placeholder="Username" class="w-full rounded-lg bg-slate-900/80 border border-slate-600 px-4 py-2 text-white">
                    <input id="admin-password" type="password" placeholder="Password" class="w-full rounded-lg bg-slate-900/80 border border-slate-600 px-4 py-2 text-white">
                    <button type="submit" class="w-full py-3 rounded-lg bg-red-700 hover:bg-red-600 text-white font-bold shadow-lg">Login</button>
                </form>
            </div>
        </div>

        <div id="admin-content-wrapper" class="hidden flex flex-col gap-5">
            <div class="grid grid-cols-2 md:grid-cols-6 gap-2 bg-slate-900/50 p-2 rounded-xl border border-slate-800">
                <button onclick="switchAdminSubTab('basic')" id="menu-basic" class="menu-btn bg-red-800/80 text-white shadow"><i class="fa-solid fa-folder-open"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> 
                <button onclick="switchAdminSubTab('scan')" id="menu-scan" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-qrcode"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="switchAdminSubTab('attendance')" id="menu-attendance" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-user-check"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="switchAdminSubTab('check')" id="menu-check" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-search"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                <button onclick="switchAdminSubTab('report')" id="menu-report" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-chart-bar"></i> ‡πÄ‡∏Å‡∏£‡∏î</button>
                <button onclick="switchAdminSubTab('attreport')" id="menu-attreport" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-table"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏•‡∏≤</button>
            </div>

            <section id="admin-panel-basic" class="admin-panel hidden glass rounded-2xl p-5">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                 <div class="glass p-4 rounded-xl border-l-4 border-l-amber-500 space-y-4">
                    <h4 class="text-sm font-semibold text-white">1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤ & ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <form id="form-subject" class="flex gap-2"><input id="subject-name" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤"><button type="submit" class="bg-amber-600 text-white px-3 py-2 rounded text-xs font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form>
                    <form id="form-class" class="flex gap-2 pt-2 border-t border-slate-700"><input id="class-name" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white" placeholder="‡∏´‡πâ‡∏≠‡∏á"><select id="class-subject-ref" class="w-1/3 bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white"></select><button type="submit" class="bg-amber-600 text-white px-3 py-2 rounded text-xs font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form>
                 </div>
                 <div class="glass p-4 rounded-xl border-l-4 border-l-blue-500">
                    <h4 class="text-sm font-semibold text-white mb-3">2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <form id="form-student" class="space-y-3">
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-5"><select id="student-class" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white"></select></div>
                            <div class="col-span-3"><input id="student-no" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white text-center" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"></div>
                            <div class="col-span-4"><input id="student-id" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white" placeholder="Scan"></div>
                        </div>
                        <div><input id="student-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </form>
                 </div>
               </div>
               <div class="glass p-4 rounded-xl border-l-4 border-l-red-500 mt-5">
                     <h4 class="text-sm font-semibold text-white mb-3">3. ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h4>
                     <form id="form-task" class="space-y-3">
                         <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="text-[10px] text-slate-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á (Auto ‡∏ß‡∏¥‡∏ä‡∏≤)</label>
                                <select id="task-class" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white"></select>
                             </div>
                             <div>
                                <label class="text-[10px] text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select id="task-category" class="w-full bg-slate-900 border border-amber-500 rounded px-2 py-2 text-xs text-amber-500 font-bold">
                                    <option value="accum">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (60)</option><option value="midterm">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</option><option value="final">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</option><option value="special">‡∏û‡∏¥‡πÄ‡∏®‡∏© (5)</option>
                                </select>
                             </div>
                         </div>
                         <div id="chapter-wrapper" class="hidden">
                             <label class="text-[10px] text-slate-400">‡∏ö‡∏ó‡∏ó‡∏µ‡πà (Chapter)</label>
                             <select id="task-chapter" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white mb-2"><option value="1">‡∏ö‡∏ó 1</option><option value="2">‡∏ö‡∏ó 2</option><option value="3">‡∏ö‡∏ó 3</option><option value="4">‡∏ö‡∏ó 4</option><option value="5">‡∏ö‡∏ó 5</option><option value="6">‡∏ö‡∏ó 6</option></select>
                        </div>
                         <div class="grid grid-cols-12 gap-2"><div class="col-span-8"><input id="task-name" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô"></div><div class="col-span-4"><input id="task-max" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white text-center" value="10"></div></div>
                         <button type="submit" class="w-full bg-red-700 text-white py-2 rounded text-sm font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
                     </form>
                     <div id="task-edit-list" class="mt-6 border-t border-slate-700 pt-4 hidden">
                         <h5 class="text-xs text-slate-400 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</h5><div class="overflow-y-auto max-h-40 bg-slate-900/50 rounded p-2 space-y-1" id="task-list-container"></div>
                     </div>
               </div>
            </section>

            <section id="admin-panel-scan" class="admin-panel hidden glass rounded-2xl p-4 flex flex-col gap-4">
                 <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 h-full min-h-[500px]">
                     <div class="lg:col-span-1 bg-slate-800/50 p-4 rounded-xl border border-slate-700 flex flex-col gap-4">
                         <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-qrcode mr-2"></i>‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (1-10)</h3>
                         <div><label class="text-xs text-slate-400">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</label><select id="scan-class-select" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white mb-2"></select><select id="scan-task-select" class="w-full bg-slate-900 border border-amber-600 rounded px-3 py-2 text-xs text-amber-500 font-bold"></select></div>
                         <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-600 flex flex-col gap-2">
                             <label class="text-xs text-slate-400">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡πÑ‡∏ß‡πâ</label>
                             <div id="score-buttons-container" class="grid grid-cols-5 gap-1"></div>
                             <button onclick="setScoreMode('manual')" id="btn-score-manual" class="w-full py-2 rounded border border-slate-500 bg-slate-800 text-slate-300 hover:bg-slate-700 text-xs font-bold btn-score-active mt-2">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á / ‡πÄ‡∏Å‡∏¥‡∏ô 10 (Max 30)</button>
                         </div>
                         <div><label class="text-xs text-slate-400 block mb-2">3. ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</label><input id="scan-score-input" type="text" class="w-full bg-slate-900 border-2 border-slate-500 rounded-xl px-4 py-3 text-lg text-center text-white focus:border-red-500 outline-none" placeholder="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô..."></div>
                     </div>
                     <div class="lg:col-span-3 bg-slate-900/40 p-4 rounded-xl border border-slate-700 flex flex-col">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-300">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Live Roster)</h3><div class="text-xs text-slate-400 flex gap-2"><span class="px-2 py-1 bg-green-900/50 text-green-400 rounded border border-green-800">‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span><span class="px-2 py-1 bg-slate-800 text-slate-500 rounded border border-slate-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</span></div></div>
                        <div id="score-roster-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto max-h-[600px] p-1"><div class="col-span-full text-center text-slate-500 py-10">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô...</div></div>
                     </div>
                 </div>
            </section>

            <section id="admin-panel-attendance" class="admin-panel hidden glass rounded-2xl p-4 flex flex-col gap-4">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 h-full min-h-[500px]">
                    <div class="lg:col-span-1 bg-slate-800/50 p-4 rounded-xl border border-slate-700 flex flex-col gap-4">
                        <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-barcode"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
                        <div><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á & ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><select id="att-class-select" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white mb-2 mt-1"></select><input id="att-date-input" type="date" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white font-mono"></div>
                        <div class="space-y-2"><button onclick="setAttMode('‡∏°‡∏≤')" id="btn-att-present" class="w-full py-3 rounded border border-green-600 bg-green-900/20 text-green-400 font-bold flex justify-between px-4"><span>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span> <i class="fa-solid fa-check"></i></button><button onclick="setAttMode('‡∏•‡∏≤')" id="btn-att-leave" class="w-full py-3 rounded border border-yellow-600 bg-yellow-900/20 text-yellow-400 font-bold flex justify-between px-4"><span>‡∏•‡∏≤</span> <i class="fa-solid fa-envelope"></i></button><button onclick="setAttMode('‡∏Ç‡∏≤‡∏î')" id="btn-att-absent" class="w-full py-3 rounded border border-red-600 bg-red-900/20 text-red-400 font-bold flex justify-between px-4"><span>‡∏Ç‡∏≤‡∏î</span> <i class="fa-solid fa-xmark"></i></button></div>
                        <input id="att-scan-input" type="text" class="w-full bg-slate-900 border-2 border-slate-500 rounded-xl px-4 py-3 text-lg text-center text-white outline-none" placeholder="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô..." disabled>
                    </div>
                    <div class="lg:col-span-3 bg-slate-900/40 p-4 rounded-xl border border-slate-700 flex flex-col">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-300">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Live)</h3></div>
                        <div id="att-roster-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto max-h-[600px] p-1"></div>
                    </div>
                </div>
            </section>

            <section id="admin-panel-check" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col gap-6">
                <div class="flex flex-col md:flex-row gap-3 items-center bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                    <select id="check-class-filter" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-white outline-none w-full md:w-auto" onchange="performCheck()"></select>
                    <input id="check-student-input" type="text" class="flex-1 w-full bg-slate-900 border border-amber-500/50 rounded-lg px-4 py-3 text-white outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-all text-center text-lg" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)" oninput="performCheck()" autofocus>
                    <button onclick="performCheck()" class="hidden md:block bg-amber-600 text-white px-6 py-3 rounded-lg font-bold w-full md:w-auto">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                </div>
                <div id="check-result" class="hidden flex flex-col gap-5 fade-in">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-red-900/50 flex justify-between items-center shadow-lg">
                        <div><h2 id="check-name" class="text-3xl font-bold text-white tracking-wide">-</h2><p id="check-class" class="text-amber-400 text-lg font-semibold mt-1">-</p></div>
                        <div class="text-right bg-slate-900/50 p-3 rounded-xl border border-slate-700"><p class="text-xs text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏°</p><p id="check-total-score" class="text-4xl font-bold text-green-400">0</p></div>
                    </div>
                    <div class="overflow-hidden bg-slate-800/40 rounded-xl border border-slate-700">
                        <table class="min-w-full text-sm text-slate-300"><thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400"><tr><th class="px-4 py-3 text-left">‡∏á‡∏≤‡∏ô</th><th class="px-4 py-3 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody id="check-table-body" class="divide-y divide-slate-700/50"></tbody></table>
                    </div>
                </div>
            </section>

            <section id="admin-panel-report" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col gap-6">
                 <div class="flex items-center justify-between"><h3 class="text-lg font-bold text-white">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3><button onclick="exportGradeCSV()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex gap-2"><i class="fa-solid fa-file-csv"></i> CSV</button></div>
                 <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700"><label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label><select id="report-class" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white"></select></div>
                 <div class="overflow-x-auto bg-slate-800/40 rounded-xl border border-slate-700"><table class="min-w-full text-sm text-slate-300"><thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400"><tr><th class="px-2 py-3 text-center">#</th><th class="px-2 py-3 text-left min-w-[150px]">‡∏ä‡∏∑‡πà‡∏≠</th><th class="px-1 py-3 text-center text-amber-500">‡∏ö‡∏ó1</th><th class="px-1 py-3 text-center text-amber-500">‡∏ö‡∏ó2</th><th class="px-1 py-3 text-center text-amber-500">‡∏ö‡∏ó3</th><th class="px-1 py-3 text-center text-amber-500">‡∏ö‡∏ó4</th><th class="px-1 py-3 text-center text-amber-500">‡∏ö‡∏ó5</th><th class="px-1 py-3 text-center text-amber-500">‡∏ö‡∏ó6</th><th class="px-1 py-3 text-center text-blue-400">‡∏Å‡∏•‡∏≤‡∏á</th><th class="px-1 py-3 text-center text-purple-400">‡∏õ‡∏•‡∏≤‡∏¢</th><th class="px-2 py-3 text-center text-white font-bold border-l border-slate-700">‡∏£‡∏ß‡∏°</th><th class="px-2 py-3 text-center">‡πÄ‡∏Å‡∏£‡∏î</th><th class="px-2 py-3 text-center text-pink-400 border-l border-slate-700">‡∏û‡∏¥‡πÄ‡∏®‡∏©</th></tr></thead><tbody id="report-table-body" class="divide-y divide-slate-700/50"></tbody></table></div>
            </section>

            <section id="admin-panel-attreport" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col gap-5">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex gap-3 items-end w-full md:w-auto">
                        <div><label class="text-xs text-slate-400 block mb-1">‡∏´‡πâ‡∏≠‡∏á</label><select id="report-att-class" class="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white min-w-[150px]"></select></div>
                        <div><label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input id="report-att-month" type="month" class="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white"></div>
                        <button onclick="renderAttReportMatrix()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold h-[38px]">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    <button onclick="exportMatrixCSV()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 h-[38px]"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                </div>
                <div class="overflow-x-auto bg-slate-900 border border-slate-700 rounded-xl shadow-inner"><table class="min-w-full text-sm text-left text-slate-300 whitespace-nowrap" id="att-matrix-table"><thead class="text-xs uppercase bg-slate-800 text-slate-400 sticky top-0 z-10 shadow"><tr id="att-matrix-header"></tr></thead><tbody id="att-matrix-body" class="divide-y divide-slate-700/50"></tbody></table></div>
            </section>
        </div>
      </div>

      <div id="section-student" class="hidden flex flex-col gap-5">
          <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-10 gap-6">
              <div class="glass p-8 rounded-2xl w-full max-w-sm shadow-xl relative flex flex-col items-center border border-slate-700">
                  <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-cyan-400"></div>
                  <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Logo" class="w-20 h-20 object-contain mb-4">
                  <h2 class="text-xl font-bold text-white mb-6">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                  <div class="w-full space-y-4">
                      <input id="student-login-id" type="text" class="w-full bg-slate-900 border-2 border-slate-600 rounded-xl px-4 py-3 text-center text-white text-lg outline-none" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£ / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™">
                      <button onclick="handleStudentLogin()" class="w-full py-3 rounded-lg bg-blue-700 hover:bg-blue-600 text-white font-bold shadow-lg">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                  </div>
              </div>
          </div>
          <div id="student-dashboard" class="hidden flex flex-col gap-6">
               <div class="glass p-6 rounded-2xl flex flex-col md:flex-row items-center gap-6 border border-slate-700 bg-gradient-to-br from-slate-900 to-slate-800">
                   <div class="h-20 w-20 rounded-full bg-slate-700 flex items-center justify-center text-3xl border-2 border-blue-500 shadow-lg">üéì</div>
                   <div class="text-center md:text-left">
                       <h2 id="std-dash-name" class="text-2xl font-bold text-white mb-1">-</h2>
                       <div class="flex gap-3 justify-center md:justify-start text-sm text-slate-400">
                           <span id="std-dash-id" class="bg-slate-800 px-2 py-1 rounded">ID: -</span>
                           <span id="std-dash-class" class="bg-slate-800 px-2 py-1 rounded text-blue-300">Class: -</span>
                       </div>
                   </div>
                   <button onclick="logoutStudent()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-solid fa-right-from-bracket"></i></button>
               </div>

               <div id="std-subjects-container" class="flex flex-col gap-6"></div>

               <div class="glass p-5 rounded-2xl border border-slate-700">
                   <h3 class="font-bold text-white mb-4 border-b border-slate-700 pb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤)</h3>
                   <div class="overflow-y-auto max-h-60"><table class="w-full text-sm text-left text-slate-300"><thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-3 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-3 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="std-att-body" class="divide-y divide-slate-700/50"></tbody></table></div>
               </div>
          </div>
      </div>

     </div>
    </main>
    
    <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <p class="text-slate-400 text-sm mb-1 text-center" id="modal-task-name"></p>
            <p class="text-amber-400 text-lg font-bold mb-4 text-center" id="modal-student-name"></p>
            <div class="relative"><input id="modal-score-input" type="number" class="w-full bg-slate-950 border-2 border-red-500 rounded-xl px-4 py-4 text-3xl text-center text-white font-bold focus:outline-none"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm">/ <span id="modal-max-score"></span></span></div>
            <div class="grid grid-cols-2 gap-3 mt-6"><button onclick="document.getElementById('score-modal').classList.add('hidden')" class="py-2 rounded-lg bg-slate-800 text-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="btn-modal-save" class="py-2 rounded-lg bg-red-700 text-white font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Enter)</button></div>
        </div>
    </div>
    <div id="edit-task-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h3>
            <form id="form-edit-task" class="space-y-3">
                <input type="hidden" id="edit-task-id">
                <div><label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input id="edit-task-name" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-white text-sm"></div>
                <div class="grid grid-cols-2 gap-2"><div><label class="text-xs text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</label><input id="edit-task-max" type="number" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-white text-sm text-center"></div><div><label class="text-xs text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="edit-task-category" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-white text-sm"><option value="accum">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö</option><option value="midterm">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</option><option value="final">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</option><option value="special">‡∏û‡∏¥‡πÄ‡∏®‡∏©</option></select></div></div>
                <div><label class="text-xs text-slate-400">‡∏ö‡∏ó‡∏ó‡∏µ‡πà</label><select id="edit-task-chapter" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-white text-sm"><option value="0">-</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('edit-task-modal').classList.add('hidden')" class="px-4 py-2 rounded bg-slate-700 text-slate-300 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 rounded bg-yellow-600 text-white text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div>
            </form>
        </div>
    </div>
    <div id="toast-notification" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-2 translate-y-20 opacity-0 font-bold border border-green-400"><i class="fa-solid fa-circle-check text-xl"></i><span id="toast-message">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></div>

   </div>
  </div>

<script>
      // ***********************************************
      // CONFIGURATION
      // ***********************************************
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec"; 
      // ***********************************************

      let dataState = { subjects:[], classes:[], students:[], tasks:[], scores:[], attendance:[] };
      let attMode = null; 
      let scoreMode = 'manual'; 

      // --- INITIALIZATION ---
      window.addEventListener('DOMContentLoaded', () => {
          const bangkokDate = getThaiDateISO();
          document.getElementById('att-date-input').value = bangkokDate;
          document.getElementById('report-att-month').value = bangkokDate.slice(0, 7);
          
          renderScoreButtons(); 
          initEventListeners();

          // Check Login Session (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å)
          const savedSession = localStorage.getItem('wany_admin_session');
          if(savedSession === 'active') {
              showAdminPanel(true); // ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          }
      });

      // --- CORE LOGIC: SYNC & UPDATE ---
      async function syncData() {
          try {
             // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet
             const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
             const json = await res.json();
             
             if(json) { 
                 dataState = json; 
                 refreshUI(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                 showToast("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß", "bg-blue-600");
             }
          } catch(e) { 
              console.error(e); 
              showToast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "bg-red-600");
          }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö)
      function refreshUI() {
          refreshDropdowns();
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
          const taskClass = document.getElementById('task-class').value;
          if(taskClass) renderTaskList(taskClass);

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
          if(!document.getElementById('admin-panel-scan').classList.contains('hidden')) {
              updateScanTaskDropdown();
              renderScoreRoster();
          }

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
          if(!document.getElementById('admin-panel-attendance').classList.contains('hidden')) {
              renderLiveRoster();
          }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ + ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
      async function saveAndRefresh(payload) {
          // 1. Optimistic Update: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Server)
          updateLocalState(payload);

          // 2. Refresh UI: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          refreshSpecificUI(payload);

          // 3. Background Sync: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Google Sheet
          try {
              // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠ (Fire and forget visual) ‡πÅ‡∏ï‡πà‡∏£‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á
              await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify(payload) });
          } catch(e) {
              console.error("Save failed", e);
              alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
          }
      }

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (Local State)
      function updateLocalState(p) {
          if(p.action === 'addSubject') dataState.subjects.push({id:p.id, name:p.name});
          
          if(p.action === 'addClass') dataState.classes.push({id:p.id, name:p.name, subjectId:p.subjectId});
          
          if(p.action === 'addStudent') {
              dataState.students.push({id:p.id, classId:p.classId, no:p.no, code:p.code, name:p.name});
          }
          
          if(p.action === 'addTask') {
              dataState.tasks.push({
                  id:p.id, classId:p.classId, subjectId:p.subjectId, 
                  category:p.category, chapter:p.chapter, 
                  name:p.name, maxScore:p.maxScore, dueDateISO:p.dueDateISO
              });
          }

          if(p.action === 'editTask') {
              const t = dataState.tasks.find(x => x.id == p.id);
              if(t) {
                  t.name = p.name; t.maxScore = p.maxScore; 
                  t.category = p.category; t.chapter = p.chapter;
              }
          }

          if(p.action === 'addScore') {
              const idx = dataState.scores.findIndex(s => s.studentId == p.studentId && s.taskId == p.taskId);
              if(idx >= 0) dataState.scores[idx].score = p.score;
              else dataState.scores.push({studentId:p.studentId, taskId:p.taskId, score:p.score});
          }

          if(p.action === 'addAttendance') {
              const idx = dataState.attendance.findIndex(a => a.studentId == p.studentId && formatThaiDate(a.date) == formatThaiDate(p.date));
              if(idx >= 0) dataState.attendance[idx].status = p.status;
              else dataState.attendance.push({studentId:p.studentId, classId:p.classId, date:p.date, status:p.status});
          }
      }

      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (Performance)
      function refreshSpecificUI(p) {
          if(['addSubject','addClass'].includes(p.action)) refreshDropdowns();
          if(p.action === 'addTask' || p.action === 'editTask') {
              renderTaskList(p.classId);
              updateScanTaskDropdown(); 
          }
          if(p.action === 'addScore') renderScoreRoster();
          // Attendance ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ú‡πà‡∏≤‡∏ô DOM ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô processAtt ‡πÅ‡∏•‡πâ‡∏ß
      }

      // --- UI HELPERS ---
      function showAdminPanel(isAutoLogin = false) {
          document.getElementById('admin-login-wrapper').classList.add('hidden');
          document.getElementById('admin-content-wrapper').classList.remove('hidden');
          document.getElementById('tab-btn-admin').className="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all";
          
          localStorage.setItem('wany_admin_session', 'active');

          if(isAutoLogin) syncData(); 
          else {
              refreshDropdowns(); 
              syncData(); 
          }
          switchAdminSubTab('attendance'); 
      }

      function handleAdminLogout() {
          localStorage.removeItem('wany_admin_session');
          location.reload(); 
      }

      function refreshDropdowns() {
          const populate = (id, arr) => {
              const el = document.getElementById(id);
              if(!el) return;
              const currentVal = el.value; 
              el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
              [...arr].sort((a,b)=>a.name.localeCompare(b.name)).forEach(i=>{
                  const opt = document.createElement('option');
                  opt.value=i.id; opt.textContent=i.name; el.appendChild(opt);
              });
              if(currentVal) el.value = currentVal; 
          };
          populate('class-subject-ref', dataState.subjects);
          populate('student-class', dataState.classes);
          populate('task-class', dataState.classes);
          populate('scan-class-select', dataState.classes);
          populate('att-class-select', dataState.classes);
          populate('check-class-filter', dataState.classes);
          populate('report-class', dataState.classes);
          populate('report-att-class', dataState.classes);
      }

      function initEventListeners() {
          document.getElementById('admin-login-form').onsubmit = (e) => {
              e.preventDefault();
              if(document.getElementById('admin-username').value === 'admin' && document.getElementById('admin-password').value === 'admin290936') {
                  showAdminPanel();
              } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
          };

          document.getElementById('form-subject').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action:'addSubject', id:Date.now(), name:document.getElementById('subject-name').value }); e.target.reset(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß"); };
          
          document.getElementById('form-class').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action:'addClass', id:Date.now(), name:document.getElementById('class-name').value, subjectId:document.getElementById('class-subject-ref').value }); e.target.reset(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); };
          
          document.getElementById('form-student').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action: 'addStudent', id: Date.now(), classId: document.getElementById('student-class').value, no: document.getElementById('student-no').value, code: document.getElementById('student-id').value, name: document.getElementById('student-name').value }); e.target.reset(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); };
          
          document.getElementById('form-task').onsubmit = (e) => { 
              e.preventDefault(); 
              const cat = document.getElementById('task-category').value;
              const clsId = document.getElementById('task-class').value;
              const clsObj = dataState.classes.find(c => c.id == clsId);
              const realSubjectId = clsObj ? clsObj.subjectId : 'DEFAULT';

              saveAndRefresh({ 
                  action: 'addTask', id: Date.now(), 
                  classId: clsId, subjectId: realSubjectId,
                  category: cat, 
                  chapter: cat === 'accum' ? document.getElementById('task-chapter').value : 0,
                  name: document.getElementById('task-name').value, 
                  maxScore: document.getElementById('task-max').value, 
                  dueDateISO: getThaiDateISO() 
              }); 
              e.target.reset(); 
              showToast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (Real-time)");
          };

          document.getElementById('form-edit-task').onsubmit = (e) => {
              e.preventDefault();
              const taskId = document.getElementById('edit-task-id').value;
              const originalTask = dataState.tasks.find(t=>t.id == taskId);
              
              saveAndRefresh({
                  action: 'editTask', id: taskId,
                  name: document.getElementById('edit-task-name').value,
                  maxScore: document.getElementById('edit-task-max').value,
                  category: document.getElementById('edit-task-category').value,
                  chapter: document.getElementById('edit-task-chapter').value,
                  classId: originalTask.classId, subjectId: originalTask.subjectId, dueDateISO: originalTask.dueDateISO
              });
              
              document.getElementById('edit-task-modal').classList.add('hidden');
              showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          };

          document.getElementById('task-class').onchange = (e) => { renderTaskList(e.target.value); };
          document.getElementById('task-category').onchange = (e) => {
              if(e.target.value === 'accum') document.getElementById('chapter-wrapper').classList.remove('hidden');
              else document.getElementById('chapter-wrapper').classList.add('hidden');
          };

          const scanInp = document.getElementById('scan-score-input');
          scanInp.onkeydown = (e) => { if(e.key==='Enter'){ handleScoreScan(scanInp.value.trim()); scanInp.value=''; } };
          document.getElementById('scan-class-select').onchange = (e) => { updateScanTaskDropdown(); renderScoreRoster(); };
          document.getElementById('scan-task-select').onchange = renderScoreRoster;
          document.getElementById('modal-score-input').onkeydown = (e) => { if (e.key === 'Enter') saveScoreFromModal(); };
          document.getElementById('btn-modal-save').onclick = saveScoreFromModal;

          document.getElementById('att-class-select').onchange = renderLiveRoster;
          document.getElementById('att-date-input').onchange = renderLiveRoster;
          const attInp = document.getElementById('att-scan-input');
          attInp.onkeydown = (e) => { if(e.key==='Enter'){ handleAttScan(attInp.value.trim()); attInp.value=''; } };
          
          document.getElementById('report-class').onchange = renderGradeReport;
          document.getElementById('student-login-id').onkeydown = (e) => { if(e.key === 'Enter') handleStudentLogin(); };
      }

      // --- RENDER & LOGIC FUNCTIONS ---
      function renderScoreButtons() {
          const container = document.getElementById('score-buttons-container');
          container.innerHTML = '';
          for(let i=1; i<=10; i++) {
              const btn = document.createElement('button');
              btn.textContent = i;
              btn.id = `btn-score-${i}`;
              btn.className = "btn-score py-2 rounded bg-slate-800 border border-slate-600 text-white hover:bg-slate-700 text-xs font-bold transition-all";
              btn.onclick = () => setScoreMode(i);
              container.appendChild(btn);
          }
      }

      function renderTaskList(classId) {
          const container = document.getElementById('task-list-container');
          const wrapper = document.getElementById('task-edit-list');
          if(!classId) { wrapper.classList.add('hidden'); return; }
          
          const tasks = dataState.tasks.filter(t => t.classId == classId).reverse();
          container.innerHTML = '';
          if(tasks.length > 0) wrapper.classList.remove('hidden'); else wrapper.classList.add('hidden');
          
          tasks.forEach(t => {
              const div = document.createElement('div');
              div.className = "flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700 hover:border-slate-500 transition-colors";
              div.innerHTML = `<div class="truncate flex-1 pr-2"><span class="text-xs text-amber-500 font-bold">[${t.category}${t.chapter>0?' '+t.chapter:''}]</span> <span class="text-sm text-slate-200">${t.name}</span> <span class="text-xs text-slate-500">(${t.maxScore}‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</span></div><button onclick="openEditTaskModal('${t.id}')" class="bg-yellow-700 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`;
              container.appendChild(div);
          });
      }

      function updateScanTaskDropdown() {
          const cid = document.getElementById('scan-class-select').value;
          const el = document.getElementById('scan-task-select');
          const currentVal = el.value;
          el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>';
          dataState.tasks.filter(t => t.classId == cid).reverse().forEach(t => {
              const opt = document.createElement('option');
              opt.value = t.id; opt.textContent = `${t.name} (${t.maxScore})`;
              el.appendChild(opt);
          });
          if(currentVal) el.value = currentVal; 
      }

      function handleScoreScan(code) {
          const tid = document.getElementById('scan-task-select').value;
          if(!tid) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
          const s = dataState.students.find(x => x.code == code);
          const t = dataState.tasks.find(x => x.id == tid);
          if(!s || !t) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
          
          if(scoreMode === 'manual') {
              openScoreModalForStudent(s, t);
          } else {
              if(Number(scoreMode) > Number(t.maxScore)) {
                  alert(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${scoreMode}) ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° (${t.maxScore}) ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ!`);
                  return;
              }
              saveScoreDirectly(s, t, scoreMode);
          }
          const inp = document.getElementById('scan-score-input');
          inp.value = '';
          inp.focus();
      }

      function saveScoreDirectly(s, t, val) {
          saveAndRefresh({ action:'addScore', studentId: s.id, taskId: t.id, score: val });
          showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${s.no}.${s.name} : ${val} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
      }

      function openScoreModalForStudent(s, t) {
          window.pendingScore = { s, t };
          document.getElementById('score-modal').classList.remove('hidden');
          document.getElementById('modal-task-name').textContent = t.name;
          document.getElementById('modal-student-name').textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${s.no} ${s.name}`;
          document.getElementById('modal-max-score').textContent = t.maxScore;
          
          const exist = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
          const inp = document.getElementById('modal-score-input');
          inp.value = exist ? exist.score : t.maxScore; 
          setTimeout(() => inp.select(), 100);
      }

      function saveScoreFromModal() {
          const val = document.getElementById('modal-score-input').value;
          const { s, t } = window.pendingScore;
          if(Number(val) > 30) { alert("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏≠ 30"); return; }
          if(Number(val) > Number(t.maxScore)) { alert(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°! (‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏° ${t.maxScore})`); return; }
          saveScoreDirectly(s, t, val);
          document.getElementById('score-modal').classList.add('hidden');
      }

      window.renderScoreRoster = function() {
          const clsId = document.getElementById('scan-class-select').value;
          const taskId = document.getElementById('scan-task-select').value;
          const div = document.getElementById('score-roster-grid');
          div.innerHTML = '';
          
          if(!clsId || !taskId) {
              div.innerHTML = '<div class="col-span-full text-center text-slate-500 py-10">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô...</div>';
              return;
          }
          
          const students = dataState.students.filter(s => s.classId == clsId).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          const task = dataState.tasks.find(t => t.id == taskId);
          
          students.forEach(s => {
              const scoreLog = dataState.scores.find(sc => sc.studentId == s.id && sc.taskId == taskId);
              const hasScore = !!scoreLog;
              const val = hasScore ? scoreLog.score : '-';
              
              const el = document.createElement('div');
              el.className = `status-box ${hasScore ? 'status-done' : 'status-none'} p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer select-none border border-slate-700`;
              el.onclick = () => openScoreModalForStudent(s, task); 
              
              el.innerHTML = `
                  <div class="text-xs opacity-70 mb-1">No. ${s.no||'-'}</div>
                  <div class="font-bold text-center text-xs truncate w-full px-1">${s.name}</div>
                  <div class="text-lg font-bold mt-1 text-white">${val} <span class="text-[10px] text-slate-400 font-normal">/${task.maxScore}</span></div>
              `;
              div.appendChild(el);
          });
      };

      // --- ATTENDANCE HANDLING ---
      function handleAttScan(code) {
          if(!attMode) return;
          const cid = document.getElementById('att-class-select').value;
          const s = dataState.students.find(x => x.code == code && x.classId == cid);
          if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö/‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á");
          processAtt(s);
      }
      function manualAtt(s) {
          if(!attMode) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô");
          processAtt(s);
      }
      function processAtt(s) {
          const date = document.getElementById('att-date-input').value;
          
          // Optimistic UI Update
          const card = document.getElementById(`card-${s.id}`);
          if(card) {
              card.className = `status-box status-${attMode} p-3 rounded-lg flex flex-col items-center justify-center cursor-pointer select-none transition-transform scale-105`;
              card.querySelector('.status-text').textContent = attMode;
              setTimeout(()=>card.classList.remove('scale-105'), 200);
          }

          saveAndRefresh({ action:'addAttendance', studentId:s.id, classId:s.classId, date:date, status:attMode });
      }

      function renderLiveRoster() {
          const cid = document.getElementById('att-class-select').value;
          const date = document.getElementById('att-date-input').value;
          const div = document.getElementById('att-roster-grid');
          div.innerHTML = '';
          if(!cid) return;
          const list = dataState.students.filter(s=>s.classId==cid).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          list.forEach(s => {
              const log = dataState.attendance.find(a => a.studentId==s.id && formatThaiDate(a.date) == formatThaiDate(date));
              const st = log ? log.status : 'none';
              const el = document.createElement('div');
              el.id = `card-${s.id}`;
              el.className = `status-box status-${st} p-3 rounded-lg flex flex-col items-center justify-center cursor-pointer select-none`;
              el.onclick = () => manualAtt(s);
              el.innerHTML = `<div class="text-xs opacity-70 mb-1">No. ${s.no||'-'}</div><div class="font-bold text-center text-sm">${s.name}</div><div class="text-[10px] mt-1 opacity-80 status-text">${st==='none'?'‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ':st}</div>`;
              div.appendChild(el);
          });
      }

      window.setAttMode = function(m) {
          attMode = m;
          ['present','leave','absent'].forEach(x => document.getElementById(`btn-att-${x}`).classList.remove('ring-4','ring-white/30','scale-105'));
          let id = m==='‡∏°‡∏≤'?'present':(m==='‡∏•‡∏≤'?'leave':'absent');
          document.getElementById(`btn-att-${id}`).classList.add('ring-4','ring-white/30','scale-105');
          const inp = document.getElementById('att-scan-input');
          inp.disabled = false; inp.placeholder=`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ [${m}] ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏¢...`; inp.focus();
      };

      // --- GENERAL UTILS ---
      function showToast(msg, bg='bg-green-600') {
          const t = document.getElementById('toast-notification');
          t.className = `fixed bottom-6 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-2 translate-y-20 opacity-0 font-bold border ${bg} border-white/20`;
          document.getElementById('toast-message').textContent = msg;
          t.classList.add('toast-show');
          setTimeout(() => t.classList.remove('toast-show'), 2500);
      }
      
      window.performCheck = function() {
          const txt = document.getElementById('check-student-input').value.trim();
          const cid = document.getElementById('check-class-filter').value;
          if(txt === "") { document.getElementById('check-result').classList.add('hidden'); return; }
          let s = dataState.students.find(x => x.code == txt || x.name.includes(txt));
          if(cid) s = dataState.students.find(x => (x.code == txt || x.name.includes(txt)) && x.classId == cid);
          if(!s) { document.getElementById('check-result').classList.add('hidden'); return; }

          document.getElementById('check-result').classList.remove('hidden');
          document.getElementById('check-name').textContent = s.name;
          const cName = dataState.classes.find(c => c.id == s.classId)?.name || '-';
          document.getElementById('check-class').textContent = cName;
          const tbody = document.getElementById('check-table-body');
          tbody.innerHTML = '';
          let total = 0;
          dataState.tasks.filter(t => t.classId == s.classId).forEach(t => {
              const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
              const val = sc ? Number(sc.score) : 0;
              if(t.category !== 'special') total += val;
              const tr = document.createElement('tr');
              const scoreClass = val > 0 ? "text-white font-bold" : "text-slate-500";
              tr.innerHTML = `<td class="px-4 py-2 text-slate-300">${t.name}</td><td class="px-4 py-2 text-right ${scoreClass}">${val} / ${t.maxScore}</td>`;
              tbody.appendChild(tr);
          });
          document.getElementById('check-total-score').textContent = total;
      };

      window.renderGradeReport = function() {
          const cid = document.getElementById('report-class').value;
          const tbody = document.getElementById('report-table-body');
          tbody.innerHTML = '';
          if(!cid) return;
          const list = dataState.students.filter(s => s.classId == cid).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          const tasks = dataState.tasks.filter(t => t.classId == cid);
          list.forEach((s, idx) => {
              let chapScores = [];
              for(let i=1; i<=6; i++) {
                  const cTasks = tasks.filter(t => t.category === 'accum' && t.chapter == i);
                  let earn=0, max=0;
                  if(cTasks.length > 0) {
                      cTasks.forEach(t => {
                          const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                          earn += sc ? Number(sc.score) : 0;
                          max += Number(t.maxScore);
                      });
                      chapScores.push(max > 0 ? Math.round((earn/max)*10) : 0);
                  } else { chapScores.push(0); }
              }
              const getSum = (cat) => {
                  let sum = 0;
                  tasks.filter(t => t.category === cat).forEach(t => {
                      const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                      sum += sc ? Number(sc.score) : 0;
                  });
                  return sum;
              };
              const mid = getSum('midterm'); const final = getSum('final'); const special = getSum('special');
              const total = chapScores.reduce((a,b)=>a+b, 0) + mid + final;
              let rowHtml = `<td class="text-center text-slate-500">${s.no||idx+1}</td><td class="px-2 py-3 text-white text-xs">${s.name}</td>`;
              chapScores.forEach(c => rowHtml += `<td class="text-center text-amber-500">${c}</td>`);
              rowHtml += `<td class="text-center text-blue-400">${mid}</td><td class="text-center text-purple-400">${final}</td><td class="text-center font-bold text-white bg-slate-800/20">${total}</td><td class="text-center text-slate-300 font-bold">${calGrade(total)}</td><td class="text-center text-pink-400 bg-pink-900/10">${special}</td>`;
              const tr = document.createElement('tr'); tr.className = "hover:bg-slate-800/30"; tr.innerHTML = rowHtml; tbody.appendChild(tr);
          });
      };
      
      function calGrade(s) { if(s>=80) return 4; if(s>=75) return 3.5; if(s>=70) return 3; if(s>=65) return 2.5; if(s>=60) return 2; if(s>=55) return 1.5; if(s>=50) return 1; return 0; }
      
      window.exportGradeCSV = function() {
          const rows = document.querySelectorAll('#report-table-body tr');
          let csv = "\uFEFFNo,Name,Ch1,Ch2,Ch3,Ch4,Ch5,Ch6,Mid,Final,Total,Grade,Special\n";
          rows.forEach(r => { csv += Array.from(r.querySelectorAll('td')).map(d=>`"${d.innerText}"`).join(',') + "\n"; });
          downloadCSV(csv, "grade_report.csv");
      };

      window.renderAttReportMatrix = function() {
          const cid = document.getElementById('report-att-class').value;
          const month = document.getElementById('report-att-month').value;
          const tbody = document.getElementById('att-matrix-body');
          const thead = document.getElementById('att-matrix-header');
          tbody.innerHTML=''; thead.innerHTML='';
          if(!cid||!month) return;
          let logs = dataState.attendance.filter(a => a.classId == cid && a.date.startsWith(month));
          let dates = [...new Set(logs.map(a=>formatThaiDate(a.date)))].sort();
          window.curAttDates = dates;
          let h = `<th class="px-4 py-3 bg-slate-800 sticky left-0 z-20 border-r border-slate-700 w-10 text-center">#</th><th class="px-4 py-3 bg-slate-800 sticky left-[40px] z-20 border-r border-slate-700 min-w-[150px]">‡∏ä‡∏∑‡πà‡∏≠</th>`;
          dates.forEach(d => h+=`<th class="px-2 py-3 text-center bg-slate-800 border-b border-slate-700 min-w-[100px] whitespace-nowrap">${d}</th>`);
          thead.innerHTML = h;
          const list = dataState.students.filter(s=>s.classId==cid).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          list.forEach(s => {
              let row = `<td class="px-4 py-2 text-center bg-slate-900 sticky left-0 z-10 border-r border-slate-800 text-slate-400">${s.no||'-'}</td><td class="px-4 py-2 bg-slate-900 sticky left-[40px] z-10 border-r border-slate-800 text-white">${s.name}</td>`;
              dates.forEach(d => {
                  const log = dataState.attendance.find(a => a.studentId==s.id && formatThaiDate(a.date) == d);
                  let t='-', c='text-slate-600';
                  if(log){ if(log.status=='‡∏°‡∏≤'){t='‚úî';c='text-green-500 font-bold';} else if(log.status=='‡∏•‡∏≤'){t='‡∏•';c='text-yellow-500';} else if(log.status=='‡∏Ç‡∏≤‡∏î'){t='‡∏Ç';c='text-red-500';} }
                  row += `<td class="px-2 py-2 text-center border-b border-slate-800 ${c}">${t}</td>`;
              });
              const tr=document.createElement('tr'); tr.innerHTML=row; tbody.appendChild(tr);
          });
      };
      window.exportMatrixCSV = function() {
          if(!window.curAttDates) return;
          let csv = "\uFEFFNo,Name," + window.curAttDates.join(',') + "\n";
          const rows = document.querySelectorAll('#att-matrix-body tr');
          rows.forEach(r => { csv += Array.from(r.querySelectorAll('td')).map(d=>`"${d.innerText}"`).join(',') + "\n"; });
          downloadCSV(csv, "att_matrix.csv");
      };

      // Student Dashboard
      window.handleStudentLogin = function() {
          const c = document.getElementById('student-login-id').value.trim();
          const s = dataState.students.find(x => x.code == c);
          if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
          document.getElementById('student-login-wrapper').classList.add('hidden');
          document.getElementById('student-dashboard').classList.remove('hidden');
          document.getElementById('std-dash-name').textContent = s.name;
          document.getElementById('std-dash-id').textContent = "ID: " + s.code;
          const cName = dataState.classes.find(cls => cls.id == s.classId)?.name || '-';
          document.getElementById('std-dash-class').textContent = "Class: " + cName;
          
          const myTasks = dataState.tasks.filter(t => t.classId == s.classId);
          const subjectsFound = [...new Set(myTasks.map(t => t.subjectId))];
          const container = document.getElementById('std-subjects-container');
          container.innerHTML = '';
          const today = getThaiDateISO();

          subjectsFound.forEach(subId => {
              const subName = dataState.subjects.find(sub => sub.id == subId)?.name || '‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
              const subjectTasks = myTasks.filter(t => t.subjectId == subId);
              let chapScores = [0,0,0,0,0,0];
              for(let i=1; i<=6; i++) {
                  const cTasks = subjectTasks.filter(t => t.category === 'accum' && t.chapter == i);
                  let earn=0, max=0;
                  cTasks.forEach(t => {
                      const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                      earn += sc ? Number(sc.score) : 0; max += Number(t.maxScore);
                  });
                  chapScores[i-1] = max > 0 ? Math.round((earn/max)*10) : 0;
              }
              const getSum = (cat) => {
                  let sum = 0;
                  subjectTasks.filter(t => t.category === cat).forEach(t => {
                      const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                      sum += sc ? Number(sc.score) : 0;
                  }); return sum;
              };
              const mid = getSum('midterm'); const final = getSum('final');
              const total = chapScores.reduce((a,b)=>a+b, 0) + mid + final;
              const grade = calGrade(total);

              const card = document.createElement('div');
              card.className = "glass p-5 rounded-2xl border border-slate-700 relative overflow-hidden";
              let html = `<h3 class="font-bold text-lg text-white mb-3 border-l-4 border-amber-500 pl-3">${subName}</h3>`;
              html += `<div class="overflow-x-auto mb-4"><table class="w-full text-sm text-center text-slate-300"><thead class="bg-slate-800 text-xs text-slate-400"><tr><th class="p-1">C1</th><th class="p-1">C2</th><th class="p-1">C3</th><th class="p-1">C4</th><th class="p-1">C5</th><th class="p-1">C6</th><th class="p-1 text-blue-400">Mid</th><th class="p-1 text-purple-400">Final</th><th class="p-1 text-white bg-slate-700">Total</th><th class="p-1 text-green-400">Grade</th></tr></thead><tbody><tr>${chapScores.map(c=>`<td class="p-1 font-bold">${c}</td>`).join('')}<td class="p-1 text-blue-300 font-bold">${mid}</td><td class="p-1 text-purple-300 font-bold">${final}</td><td class="p-1 text-white font-bold bg-slate-700/50">${total}</td><td class="p-1 text-green-400 font-bold text-lg">${grade}</td></tr></tbody></table></div>`;
              
              // Grid Button UI
              html += `<div class="mt-2"><h4 class="text-xs text-slate-400 mb-2 font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h4><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 max-h-60 overflow-y-auto pr-1">`;
              subjectTasks.forEach(t => {
                  const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                  let statusClass = "", statusText = "", icon = "";
                  if(sc) { statusClass = "bg-green-900/30 border-green-600 text-green-400 hover:bg-green-900/50"; statusText = `${sc.score}`; icon = `<i class="fa-solid fa-check-circle mb-1"></i>`; }
                  else if(t.dueDateISO < today) { statusClass = "bg-red-900/30 border-red-600 text-red-400 hover:bg-red-900/50"; statusText = "‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á"; icon = `<i class="fa-solid fa-circle-exclamation mb-1"></i>`; }
                  else { statusClass = "bg-yellow-900/30 border-yellow-600 text-yellow-400 hover:bg-yellow-900/50"; statusText = "‡∏£‡∏≠‡∏™‡πà‡∏á"; icon = `<i class="fa-regular fa-clock mb-1"></i>`; }
                  html += `<div class="${statusClass} border rounded-lg p-3 flex flex-col items-center justify-center text-center transition-all cursor-default relative"><div class="text-[10px] text-slate-300 absolute top-1 right-2 w-full text-right truncate pl-2 opacity-50">${t.category}</div><div class="text-lg mt-2">${icon}</div><div class="text-xs font-bold truncate w-full px-1 mb-1">${t.name}</div><div class="text-sm font-bold bg-slate-900/40 px-2 rounded mt-1">${statusText} <span class="text-[10px] font-normal opacity-70">/${t.maxScore}</span></div></div>`;
              });
              html += `</div></div>`;
              card.innerHTML = html; container.appendChild(card);
          });

          // Att History
          const ab = document.getElementById('std-att-body'); ab.innerHTML = '';
          const atts = dataState.attendance.filter(a => a.studentId == s.id).sort((a,b) => b.date.localeCompare(a.date));
          atts.forEach(a => {
              const c = a.status == '‡∏°‡∏≤' ? 'text-green-400' : (a.status == '‡∏•‡∏≤' ? 'text-yellow-400' : 'text-red-400');
              const tr = document.createElement('tr');
              tr.innerHTML = `<td class="px-3 py-2 text-slate-400">${formatThaiDate(a.date)}</td><td class="px-3 py-2 text-center font-bold ${c}">${a.status}</td>`;
              ab.appendChild(tr);
          });
      };

      window.logoutStudent = function() { document.getElementById('student-dashboard').classList.add('hidden'); document.getElementById('student-login-wrapper').classList.remove('hidden'); document.getElementById('student-login-id').value=''; };
      function switchMainTab(t) { document.getElementById('section-admin').classList.add('hidden'); document.getElementById('section-student').classList.add('hidden'); document.getElementById('tab-btn-admin').className="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all"; document.getElementById('tab-btn-student').className="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all"; if(t=='admin'){ 
          if(localStorage.getItem('wany_admin_session') === 'active') { showAdminPanel(); } 
          else { document.getElementById('section-admin').classList.remove('hidden'); document.getElementById('admin-login-wrapper').classList.remove('hidden'); document.getElementById('admin-content-wrapper').classList.add('hidden'); document.getElementById('tab-btn-admin').className="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all"; }
      } else { document.getElementById('section-student').classList.remove('hidden'); document.getElementById('tab-btn-student').className="px-5 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 shadow-lg transition-all"; document.getElementById('student-login-id').focus(); } }
      function switchAdminSubTab(t) { document.querySelectorAll('.admin-panel').forEach(p=>p.classList.add('hidden')); document.getElementById(`admin-panel-${t}`).classList.remove('hidden'); document.querySelectorAll('.menu-btn').forEach(b=>{b.classList.remove('bg-red-800/80','text-white','shadow'); b.classList.add('text-slate-400');}); document.getElementById(`menu-${t}`).classList.remove('text-slate-400'); document.getElementById(`menu-${t}`).classList.add('bg-red-800/80','text-white','shadow'); if(t=='attendance') renderLiveRoster(); if(t=='scan') renderScoreRoster(); }
      window.openEditTaskModal = function(taskId) { const t = dataState.tasks.find(x => x.id == taskId); if(!t) return; document.getElementById('edit-task-id').value = t.id; document.getElementById('edit-task-name').value = t.name; document.getElementById('edit-task-max').value = t.maxScore; document.getElementById('edit-task-category').value = t.category; document.getElementById('edit-task-chapter').value = t.chapter || 0; document.getElementById('edit-task-modal').classList.remove('hidden'); };
      function getThaiDateISO() { const d = new Date(); const utc = d.getTime() + (d.getTimezoneOffset() * 60000); const bangkok = new Date(utc + (7 * 3600000)); return `${bangkok.getFullYear()}-${String(bangkok.getMonth()+1).padStart(2,'0')}-${String(bangkok.getDate()).padStart(2,'0')}`; }
      function formatThaiDate(dateString) { if(!dateString) return "-"; if(dateString.includes('T') || dateString.includes('Z')) { const d = new Date(dateString); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; } const [year, month, day] = dateString.split('-'); return `${year}/${month}/${day}`; }
      function downloadCSV(csv,n) { const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"})); l.download=n; l.click(); }
  </script>
 </body>
</html>
