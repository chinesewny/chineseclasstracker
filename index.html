<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <title>ChineseClass System V6.3 (Full Option)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
      body { font-family: 'Sarabun', sans-serif; }
      @view-transition { navigation: auto; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
      
      /* Status Colors */
      .status-box { transition: all 0.3s; }
      .status-none { background: rgba(51, 65, 85, 0.5); border: 1px dashed #475569; color: #94a3b8; }
      .status-‡∏°‡∏≤ { background: #15803d; border: 1px solid #22c55e; color: white; box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
      .status-‡∏•‡∏≤ { background: #a16207; border: 1px solid #eab308; color: white; }
      .status-‡∏Ç‡∏≤‡∏î { background: #b91c1c; border: 1px solid #ef4444; color: white; }

      /* Toast Notification */
      #toast-notification {
          transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      }
  </style>
 </head>
 <body class="w-full h-full bg-slate-950 text-slate-200">
  <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center">
   <div class="app-wrapper w-full max-w-7xl my-2 md:my-4 mx-2 rounded-2xl bg-slate-900/90 shadow-2xl border border-slate-800 flex flex-col relative overflow-hidden">
    
    <header class="w-full px-6 py-4 border-b border-slate-800 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-slate-900 z-10">
     <div class="flex items-center gap-4">
      <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="School Logo" class="h-14 w-14 object-contain drop-shadow-md bg-white/10 rounded-full p-1 border border-slate-600">
      <div>
        <h1 class="text-2xl font-bold text-white tracking-wide">Chinese<span class="text-red-500">Class</span> V6</h1>
        <p class="text-slate-400 text-xs">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô</p>
      </div>
     </div>
     <nav class="inline-flex rounded-full bg-slate-950 p-1 border border-slate-800">
        <button id="tab-btn-admin" onclick="switchMainTab('admin')" class="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all"><i class="fa-solid fa-chalkboard-user mr-2"></i>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button> 
        <button id="tab-btn-student" onclick="switchMainTab('student')" class="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all"><i class="fa-solid fa-user-graduate mr-2"></i>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
     </nav>
    </header>

    <main class="flex-1 w-full px-4 md:px-6 pb-6 overflow-y-auto">
     <div class="w-full max-w-7xl mx-auto mt-6 flex flex-col gap-6">
      
      <div id="section-admin" class="flex flex-col gap-5">
        
        <div id="admin-login-wrapper" class="flex flex-col items-center justify-center py-10 gap-6">
            <div class="glass p-8 rounded-2xl w-full max-w-sm shadow-xl relative overflow-hidden flex flex-col items-center border border-slate-700">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-amber-500"></div>
                <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Logo" class="w-20 h-20 object-contain mb-4 drop-shadow-md">
                <h2 class="text-xl font-bold text-white text-center mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
                <form id="admin-login-form" class="space-y-4 w-full">
                    <input id="admin-username" type="text" placeholder="Username" class="w-full rounded-lg border border-slate-600 bg-slate-900/80 text-white px-4 py-2.5 outline-none">
                    <input id="admin-password" type="password" placeholder="Password" class="w-full rounded-lg border border-slate-600 bg-slate-900/80 text-white px-4 py-2.5 outline-none">
                    <button type="submit" class="w-full py-3 rounded-lg bg-red-700 hover:bg-red-600 text-white font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
            </div>
        </div>

        <div id="admin-content-wrapper" class="hidden flex flex-col gap-5">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 bg-slate-900/50 p-2 rounded-xl border border-slate-800">
                <button onclick="switchAdminSubTab('basic')" id="menu-basic" class="menu-btn bg-red-800/80 text-white shadow"><i class="fa-solid fa-folder-open mr-1"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> 
                <button onclick="switchAdminSubTab('scan')" id="menu-scan" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-qrcode mr-1"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="switchAdminSubTab('attendance')" id="menu-attendance" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-user-check mr-1"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="switchAdminSubTab('check')" id="menu-check" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-search mr-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                <button onclick="switchAdminSubTab('report')" id="menu-report" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-chart-bar mr-1"></i> ‡πÄ‡∏Å‡∏£‡∏î</button>
                <button onclick="switchAdminSubTab('attreport')" id="menu-attreport" class="menu-btn text-slate-400 hover:text-white"><i class="fa-solid fa-table mr-1"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏•‡∏≤</button>
            </div>

            <section id="admin-panel-basic" class="admin-panel hidden glass rounded-2xl p-5">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                 
                 <div class="glass p-4 rounded-xl border-l-4 border-l-amber-500 space-y-4">
                    <h4 class="text-sm font-semibold text-white">1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤ & ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <form id="form-subject" class="flex gap-2 items-center">
                        <input id="subject-name" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏µ‡∏ô ‡∏õ.1)">
                        <button type="submit" class="bg-amber-600 text-white px-4 py-2 rounded text-xs font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>
                    </form>
                    <form id="form-class" class="flex gap-2 items-center pt-2 border-t border-slate-700">
                        <input id="class-name" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white" placeholder="‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.1/1)">
                        <select id="class-subject-ref" class="w-1/3 bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white"></select>
                        <button type="submit" class="bg-amber-600 text-white px-4 py-2 rounded text-xs font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
                    </form>
                 </div>

                 <div class="glass p-4 rounded-xl border-l-4 border-l-blue-500">
                    <h4 class="text-sm font-semibold text-white mb-3">2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <form id="form-student" class="space-y-3">
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-5"><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á</label><select id="student-class" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white"></select></div>
                            <div class="col-span-3"><label class="text-xs text-slate-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input id="student-no" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white text-center" placeholder="1"></div>
                            <div class="col-span-4"><label class="text-xs text-slate-400">‡∏£‡∏´‡∏±‡∏™</label><input id="student-id" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white" placeholder="Scan"></div>
                        </div>
                        <div><input id="student-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </form>
                 </div>
               </div>

               <div class="glass p-4 rounded-xl border-l-4 border-l-red-500 mt-5">
                     <h4 class="text-sm font-semibold text-white mb-3">3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
                     <form id="form-task" class="space-y-3">
                         <div class="grid grid-cols-2 gap-3">
                             <select id="task-class" class="bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white"></select>
                             <select id="task-category" class="bg-slate-900 border border-amber-500 rounded px-2 py-2 text-xs text-amber-500 font-bold">
                                 <option value="accum">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (60)</option>
                                 <option value="midterm">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</option>
                                 <option value="final">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</option>
                                 <option value="special">‡∏û‡∏¥‡πÄ‡∏®‡∏©/‡∏à‡∏¥‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢ (5)</option>
                             </select>
                         </div>
                         <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-8"><input id="task-name" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô"></div>
                            <div class="col-span-4"><input id="task-max" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white text-center" value="10"></div>
                         </div>
                         <button type="submit" class="w-full bg-red-700 text-white py-2 rounded text-sm font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
                     </form>
               </div>
            </section>

            <section id="admin-panel-scan" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col items-center">
                 <div class="w-full max-w-md space-y-4">
                     <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 w-full">
                         <label class="text-sm text-slate-400 block mb-1">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                         <select id="scan-class-select" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white mb-3"></select>
                         <label class="text-sm text-slate-400 block mb-1">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</label>
                         <select id="scan-task-select" class="w-full bg-slate-900 border border-amber-600 rounded px-3 py-2 text-amber-500 font-bold"></select>
                     </div>
                     <div class="w-full">
                         <label class="text-sm text-slate-400 block mb-1 ml-1">3. ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</label>
                         <input id="scan-score-input" type="text" class="w-full bg-slate-900 border-2 border-slate-500 rounded-xl px-4 py-4 text-2xl text-center text-white focus:border-red-500 outline-none" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...">
                     </div>
                 </div>
            </section>

            <section id="admin-panel-attendance" class="admin-panel hidden glass rounded-2xl p-4 flex flex-col gap-4">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 h-full min-h-[500px]">
                    <div class="lg:col-span-1 bg-slate-800/50 p-4 rounded-xl border border-slate-700 flex flex-col gap-4">
                        <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-barcode mr-2"></i>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
                        <div>
                            <label class="text-xs text-slate-400">1. ‡∏´‡πâ‡∏≠‡∏á & ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <select id="att-class-select" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white mb-2 mt-1"></select>
                            <input id="att-date-input" type="date" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white font-mono">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 block mb-2">2. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)</label>
                            <div class="space-y-2">
                                <button onclick="setAttMode('‡∏°‡∏≤')" id="btn-att-present" class="w-full py-3 rounded border border-green-600 bg-green-900/20 text-green-400 hover:bg-green-600 hover:text-white font-bold flex justify-between px-4"><span>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span> <i class="fa-solid fa-check"></i></button>
                                <button onclick="setAttMode('‡∏•‡∏≤')" id="btn-att-leave" class="w-full py-3 rounded border border-yellow-600 bg-yellow-900/20 text-yellow-400 hover:bg-yellow-600 hover:text-white font-bold flex justify-between px-4"><span>‡∏•‡∏≤</span> <i class="fa-solid fa-envelope"></i></button>
                                <button onclick="setAttMode('‡∏Ç‡∏≤‡∏î')" id="btn-att-absent" class="w-full py-3 rounded border border-red-600 bg-red-900/20 text-red-400 hover:bg-red-600 hover:text-white font-bold flex justify-between px-4"><span>‡∏Ç‡∏≤‡∏î</span> <i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 block mb-2">3. ‡∏™‡πÅ‡∏Å‡∏ô</label>
                            <input id="att-scan-input" type="text" class="w-full bg-slate-900 border-2 border-slate-500 rounded-xl px-4 py-3 text-lg text-center text-white focus:border-blue-500 outline-none" placeholder="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô..." disabled>
                        </div>
                    </div>
                    <div class="lg:col-span-3 bg-slate-900/40 p-4 rounded-xl border border-slate-700 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-300">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Live)</h3>
                            <div class="text-xs text-slate-400 flex gap-2">
                                <span class="px-2 py-1 bg-green-900/50 text-green-400 rounded">‡∏°‡∏≤</span>
                                <span class="px-2 py-1 bg-yellow-900/50 text-yellow-400 rounded">‡∏•‡∏≤</span>
                                <span class="px-2 py-1 bg-red-900/50 text-red-400 rounded">‡∏Ç‡∏≤‡∏î</span>
                            </div>
                        </div>
                        <div id="att-roster-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto max-h-[600px] p-1">
                             <div class="col-span-full text-center text-slate-500 py-10">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="admin-panel-check" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col gap-6">
                <div class="flex flex-col md:flex-row gap-3 items-center bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                    <select id="check-class-filter" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-white outline-none w-full md:w-auto"></select>
                    <input id="check-student-input" type="text" class="flex-1 w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™...">
                    <button onclick="performCheck()" class="bg-amber-600 text-white px-6 py-3 rounded-lg font-bold w-full md:w-auto">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                </div>
                <div id="check-result" class="hidden flex flex-col gap-5">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-red-900/50 flex justify-between items-center">
                        <div>
                            <h2 id="check-name" class="text-2xl font-bold text-white">-</h2>
                            <p id="check-class" class="text-amber-400">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏°</p>
                            <p id="check-total-score" class="text-3xl font-bold text-white">0</p>
                        </div>
                    </div>
                    <div class="overflow-hidden bg-slate-800/40 rounded-xl border border-slate-700">
                        <table class="min-w-full text-sm text-slate-300">
                            <thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400">
                                <tr><th class="px-4 py-3 text-left">‡∏á‡∏≤‡∏ô</th><th class="px-4 py-3 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="px-4 py-3 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr>
                            </thead>
                            <tbody id="check-table-body" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="admin-panel-report" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col gap-6">
                 <div class="flex items-center justify-between">
                     <h3 class="text-lg font-bold text-white">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô & ‡πÄ‡∏Å‡∏£‡∏î</h3>
                     <button onclick="exportGradeCSV()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i class="fa-solid fa-file-csv"></i> CSV</button>
                 </div>
                 <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <select id="report-class" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white"></select>
                 </div>
                 <div class="overflow-x-auto bg-slate-800/40 rounded-xl border border-slate-700">
                    <table class="min-w-full text-sm text-slate-300">
                        <thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400">
                            <tr>
                                <th class="px-2 py-3 text-center w-10">#</th>
                                <th class="px-2 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th class="px-1 py-3 text-center text-amber-500">‡πÄ‡∏Å‡πá‡∏ö</th>
                                <th class="px-1 py-3 text-center text-blue-400">‡∏Å‡∏•‡∏≤‡∏á</th>
                                <th class="px-1 py-3 text-center text-purple-400">‡∏õ‡∏•‡∏≤‡∏¢</th>
                                <th class="px-2 py-3 text-center text-white font-bold border-l border-slate-700">‡∏£‡∏ß‡∏°</th>
                                <th class="px-2 py-3 text-center">‡πÄ‡∏Å‡∏£‡∏î</th>
                                <th class="px-2 py-3 text-center text-pink-400 border-l border-slate-700">‡∏û‡∏¥‡πÄ‡∏®‡∏©</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-slate-700/50"></tbody>
                    </table>
                 </div>
            </section>

            <section id="admin-panel-attreport" class="admin-panel hidden glass rounded-2xl p-5 flex flex-col gap-5">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex gap-3 items-end w-full md:w-auto">
                        <div><label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label><select id="report-att-class" class="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white min-w-[150px]"></select></div>
                        <div><label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input id="report-att-month" type="month" class="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white"></div>
                        <button onclick="renderAttReportMatrix()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold h-[38px]">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    <button onclick="exportMatrixCSV()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 h-[38px]"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                </div>
                <div class="overflow-x-auto bg-slate-900 border border-slate-700 rounded-xl shadow-inner">
                    <table class="min-w-full text-sm text-left text-slate-300 whitespace-nowrap" id="att-matrix-table">
                        <thead class="text-xs uppercase bg-slate-800 text-slate-400 sticky top-0 z-10 shadow"><tr id="att-matrix-header"></tr></thead>
                        <tbody id="att-matrix-body" class="divide-y divide-slate-700/50"></tbody>
                    </table>
                </div>
            </section>
        </div>
      </div>

      <div id="section-student" class="hidden flex flex-col gap-5">
          <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-10 gap-6">
              <div class="glass p-8 rounded-2xl w-full max-w-sm shadow-xl relative overflow-hidden flex flex-col items-center border border-slate-700">
                  <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-cyan-400"></div>
                  <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Logo" class="w-20 h-20 object-contain mb-4 drop-shadow-md">
                  <h2 class="text-xl font-bold text-white text-center mb-6">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                  <div class="w-full space-y-4">
                      <input id="student-login-id" type="text" class="w-full bg-slate-900 border-2 border-slate-600 rounded-xl px-4 py-3 text-center text-white text-lg focus:border-blue-500 outline-none" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™">
                      <button onclick="handleStudentLogin()" class="w-full py-3 rounded-lg bg-blue-700 hover:bg-blue-600 text-white font-bold shadow-lg">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                  </div>
              </div>
          </div>
          <div id="student-dashboard" class="hidden flex flex-col gap-6">
               <div class="glass p-6 rounded-2xl flex flex-col md:flex-row items-center gap-6 border border-slate-700 bg-gradient-to-br from-slate-900 to-slate-800">
                   <div class="h-20 w-20 rounded-full bg-slate-700 flex items-center justify-center text-3xl border-2 border-blue-500 shadow-lg">üéì</div>
                   <div class="text-center md:text-left">
                       <h2 id="std-dash-name" class="text-2xl font-bold text-white mb-1">-</h2>
                       <div class="flex gap-3 justify-center md:justify-start text-sm text-slate-400">
                           <span id="std-dash-id" class="bg-slate-800 px-2 py-1 rounded">ID: -</span>
                           <span id="std-dash-class" class="bg-slate-800 px-2 py-1 rounded text-blue-300">Class: -</span>
                       </div>
                   </div>
                   <div class="ml-auto flex gap-4 text-center">
                       <div><p class="text-xs text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</p><p id="std-dash-score" class="text-2xl font-bold text-amber-400">0</p></div>
                       <div><p class="text-xs text-slate-400">‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p><p id="std-dash-att" class="text-2xl font-bold text-green-400">0%</p></div>
                   </div>
                   <button onclick="logoutStudent()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-solid fa-right-from-bracket"></i></button>
               </div>
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                   <div class="glass p-5 rounded-2xl border border-slate-700">
                       <h3 class="font-bold text-white mb-4 border-b border-slate-700 pb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                       <div class="overflow-y-auto max-h-60"><table class="w-full text-sm text-left text-slate-300"><thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-3 py-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="px-3 py-2 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody id="std-score-body" class="divide-y divide-slate-700/50"></tbody></table></div>
                   </div>
                   <div class="glass p-5 rounded-2xl border border-slate-700">
                       <h3 class="font-bold text-white mb-4 border-b border-slate-700 pb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                       <div class="overflow-y-auto max-h-60"><table class="w-full text-sm text-left text-slate-300"><thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-3 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-3 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="std-att-body" class="divide-y divide-slate-700/50"></tbody></table></div>
                   </div>
               </div>
          </div>
      </div>

     </div>
    </main>
    
    <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <p class="text-slate-400 text-sm mb-1 text-center" id="modal-task-name"></p>
            <p class="text-amber-400 text-lg font-bold mb-4 text-center" id="modal-student-name"></p>
            <div class="relative">
                <input id="modal-score-input" type="number" class="w-full bg-slate-950 border-2 border-red-500 rounded-xl px-4 py-4 text-3xl text-center text-white font-bold focus:outline-none">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm">/ <span id="modal-max-score"></span></span>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="document.getElementById('score-modal').classList.add('hidden')" class="py-2 rounded-lg bg-slate-800 text-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-modal-save" class="py-2 rounded-lg bg-red-700 text-white font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-2 translate-y-full opacity-0 transition-all font-bold">
        <i class="fa-solid fa-circle-check"></i>
        <span id="toast-message">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
    </div>

   </div>
  </div>

  <script>
      // ***************** CONFIG *****************
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec"; 
      // ******************************************

      let dataState = { subjects:[], classes:[], students:[], tasks:[], scores:[], attendance:[] };
      let attMode = null; 

      window.addEventListener('DOMContentLoaded', () => {
          // Force Thai Date Display in Inputs
          const bangkokDate = getThaiDateISO();
          document.getElementById('att-date-input').value = bangkokDate;
          document.getElementById('report-att-month').value = bangkokDate.slice(0, 7);
          
          syncData();
          initEventListeners();
      });

      // --- DATE UTILITY ---
      function getThaiDateISO() {
          const d = new Date();
          const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
          const bangkok = new Date(utc + (7 * 3600000));
          const y = bangkok.getFullYear();
          const m = String(bangkok.getMonth() + 1).padStart(2, '0');
          const day = String(bangkok.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
      }

      function formatThaiDate(dateString) {
          if(!dateString) return "-";
          // Important: Split string directly
          const cleanDate = dateString.split('T')[0];
          const [year, month, day] = cleanDate.split('-');
          const m = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."][parseInt(month)-1];
          return `${parseInt(day)} ${m} ${parseInt(year)+543}`;
      }

      async function syncData() {
          try {
             const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
             const json = await res.json();
             if(json) { dataState = json; refreshUI(); }
          } catch(e) { console.error(e); }
      }

      function refreshUI() {
          const populate = (id, arr) => {
              const el = document.getElementById(id);
              if(!el) return;
              el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
              [...arr].sort((a,b)=>a.name.localeCompare(b.name)).forEach(i=>{
                  const opt = document.createElement('option');
                  opt.value=i.id; opt.textContent=i.name; el.appendChild(opt);
              });
          };
          populate('student-class', dataState.classes);
          populate('task-class', dataState.classes);
          populate('scan-class-select', dataState.classes);
          populate('att-class-select', dataState.classes);
          populate('check-class-filter', dataState.classes);
          populate('report-class', dataState.classes);
          populate('report-att-class', dataState.classes);
          populate('class-subject-ref', dataState.subjects); // Added
      }

      function initEventListeners() {
          // Login
          document.getElementById('admin-login-form').onsubmit = (e) => {
              e.preventDefault();
              if(document.getElementById('admin-username').value === 'admin' && document.getElementById('admin-password').value === 'admin290936') {
                  document.getElementById('admin-login-wrapper').classList.add('hidden');
                  document.getElementById('admin-content-wrapper').classList.remove('hidden');
                  switchAdminSubTab('attendance');
              } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
          };
          document.getElementById('student-login-id').onkeydown = (e) => { if(e.key === 'Enter') handleStudentLogin(); };

          // Basic Forms
          document.getElementById('form-subject').onsubmit = (e) => {
              e.preventDefault();
              saveAndRefresh({ action:'addSubject', id:Date.now(), name:document.getElementById('subject-name').value });
              e.target.reset(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
          };
          document.getElementById('form-class').onsubmit = (e) => {
              e.preventDefault();
              saveAndRefresh({ action:'addClass', id:Date.now(), name:document.getElementById('class-name').value, subjectId:document.getElementById('class-subject-ref').value });
              e.target.reset(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
          };
          document.getElementById('form-student').onsubmit = (e) => {
              e.preventDefault();
              saveAndRefresh({
                  action: 'addStudent', id: Date.now(),
                  classId: document.getElementById('student-class').value,
                  no: document.getElementById('student-no').value,
                  code: document.getElementById('student-id').value,
                  name: document.getElementById('student-name').value, email:''
              });
              e.target.reset(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
          };
          document.getElementById('form-task').onsubmit = (e) => {
              e.preventDefault();
              saveAndRefresh({
                  action: 'addTask', id: Date.now(),
                  classId: document.getElementById('task-class').value,
                  subjectId: 'DEFAULT', 
                  category: document.getElementById('task-category').value,
                  name: document.getElementById('task-name').value,
                  maxScore: document.getElementById('task-max').value,
                  dueDateISO: getThaiDateISO()
              });
              e.target.reset(); alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
          };

          // Scan Score
          const scanInp = document.getElementById('scan-score-input');
          scanInp.onkeydown = (e) => { if(e.key==='Enter'){ handleScoreScan(scanInp.value.trim()); scanInp.value=''; } };
          document.getElementById('scan-class-select').onchange = updateScanTaskDropdown;

          // Enter key inside Modal
          document.getElementById('modal-score-input').onkeydown = (e) => {
              if (e.key === 'Enter') saveScoreFromModal();
          };

          // Attendance
          document.getElementById('att-class-select').onchange = renderLiveRoster;
          document.getElementById('att-date-input').onchange = renderLiveRoster;
          const attInp = document.getElementById('att-scan-input');
          attInp.onkeydown = (e) => { if(e.key==='Enter'){ handleAttScan(attInp.value.trim()); attInp.value=''; } };
          
          // Report
          document.getElementById('report-class').onchange = renderGradeReport;
          document.getElementById('btn-modal-save').onclick = saveScoreFromModal;
      }

      // --- TOAST NOTIFICATION ---
      function showToast(msg) {
          const t = document.getElementById('toast-notification');
          document.getElementById('toast-message').textContent = msg;
          t.classList.remove('translate-y-full', 'opacity-0');
          setTimeout(() => t.classList.add('translate-y-full', 'opacity-0'), 3000);
      }

      // --- LOGIC: SCAN SCORE ---
      function updateScanTaskDropdown() {
          const cid = document.getElementById('scan-class-select').value;
          const el = document.getElementById('scan-task-select');
          el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>';
          dataState.tasks.filter(t => t.classId == cid).reverse().forEach(t => {
              const opt = document.createElement('option');
              opt.value = t.id; opt.textContent = `${t.name} (${t.maxScore})`;
              el.appendChild(opt);
          });
      }
      function handleScoreScan(code) {
          const tid = document.getElementById('scan-task-select').value;
          if(!tid) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
          const s = dataState.students.find(x => x.code == code);
          const t = dataState.tasks.find(x => x.id == tid);
          if(!s || !t) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
          
          document.getElementById('score-modal').classList.remove('hidden');
          document.getElementById('modal-task-name').textContent = t.name;
          document.getElementById('modal-student-name').textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${s.no} ${s.name}`;
          document.getElementById('modal-max-score').textContent = t.maxScore;
          window.pendingScore = { s, t };
          
          const exist = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
          const inp = document.getElementById('modal-score-input');
          inp.value = exist ? exist.score : t.maxScore;
          setTimeout(() => inp.select(), 100);
      }
      function saveScoreFromModal() {
          const val = document.getElementById('modal-score-input').value;
          const { s, t } = window.pendingScore;
          
          // 1. Optimistic Update
          const exist = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
          if(exist) exist.score = val;
          else dataState.scores.push({ studentId: s.id, taskId: t.id, score: val });

          // 2. Send
          saveAndRefresh({ action:'addScore', studentId: s.id, taskId: t.id, score: val });
          
          // 3. UI Feedback
          document.getElementById('score-modal').classList.add('hidden');
          showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${s.no}.${s.name} : ${val} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
          document.getElementById('scan-score-input').focus();
      }

      // --- LOGIC: ATTENDANCE ---
      window.setAttMode = function(m) {
          attMode = m;
          ['present','leave','absent'].forEach(x => document.getElementById(`btn-att-${x}`).classList.remove('ring-4','ring-white/30','scale-105'));
          let id = m==='‡∏°‡∏≤'?'present':(m==='‡∏•‡∏≤'?'leave':'absent');
          document.getElementById(`btn-att-${id}`).classList.add('ring-4','ring-white/30','scale-105');
          const inp = document.getElementById('att-scan-input');
          inp.disabled = false; inp.placeholder=`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ [${m}] ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏¢...`; inp.focus();
      };
      function renderLiveRoster() {
          const cid = document.getElementById('att-class-select').value;
          const date = document.getElementById('att-date-input').value;
          const div = document.getElementById('att-roster-grid');
          div.innerHTML = '';
          if(!cid) return;
          const list = dataState.students.filter(s=>s.classId==cid).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          if(!list.length) div.innerHTML='<div class="col-span-full text-center text-slate-500">‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>';
          list.forEach(s => {
              const log = dataState.attendance.find(a => a.studentId==s.id && a.date.startsWith(date));
              const st = log ? log.status : 'none';
              const el = document.createElement('div');
              el.id = `card-${s.id}`;
              el.className = `status-box status-${st} p-3 rounded-lg flex flex-col items-center justify-center cursor-pointer select-none`;
              el.onclick = () => manualAtt(s);
              el.innerHTML = `<div class="text-xs opacity-70 mb-1">No. ${s.no||'-'}</div><div class="font-bold text-center text-sm">${s.name}</div><div class="text-[10px] mt-1 opacity-80 status-text">${st==='none'?'‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ':st}</div>`;
              div.appendChild(el);
          });
      }
      function handleAttScan(code) {
          if(!attMode) return;
          const cid = document.getElementById('att-class-select').value;
          const s = dataState.students.find(x => x.code == code && x.classId == cid);
          if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö/‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á");
          processAtt(s);
      }
      function manualAtt(s) {
          if(!attMode) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô");
          processAtt(s);
      }
      function processAtt(s) {
          const date = document.getElementById('att-date-input').value;
          const exist = dataState.attendance.find(a => a.studentId == s.id && a.date.startsWith(date));
          if(exist) {
              if(exist.status !== attMode) {
                  if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${s.name} ‡∏à‡∏≤‡∏Å ${exist.status} ‡πÄ‡∏õ‡πá‡∏ô ${attMode}?`)) return;
                  dataState.attendance = dataState.attendance.filter(a => a !== exist);
              } else return;
          }
          const p = { action:'addAttendance', studentId:s.id, classId:s.classId, date:date, status:attMode };
          dataState.attendance.push({ ...p, timestampISO:new Date().toISOString() });
          
          const card = document.getElementById(`card-${s.id}`);
          if(card) {
              card.className = `status-box status-${attMode} p-3 rounded-lg flex flex-col items-center justify-center cursor-pointer select-none transition-transform scale-105`;
              card.querySelector('.status-text').textContent = attMode;
              setTimeout(()=>card.classList.remove('scale-105'), 200);
          }
          saveAndRefresh(p);
      }

      // --- LOGIC: CHECK INDIVIDUAL ---
      window.performCheck = function() {
          const txt = document.getElementById('check-student-input').value.trim();
          const cid = document.getElementById('check-class-filter').value;
          let s = dataState.students.find(x => x.code == txt || x.name.includes(txt));
          if(cid) s = dataState.students.find(x => (x.code == txt || x.name.includes(txt)) && x.classId == cid);
          
          if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
          document.getElementById('check-result').classList.remove('hidden');
          document.getElementById('check-name').textContent = s.name;
          const cName = dataState.classes.find(c => c.id == s.classId)?.name || '-';
          document.getElementById('check-class').textContent = cName;
          
          const tbody = document.getElementById('check-table-body');
          tbody.innerHTML = '';
          let total = 0;
          const tasks = dataState.tasks.filter(t => t.classId == s.classId);
          tasks.forEach(t => {
              const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
              const val = sc ? Number(sc.score) : 0;
              if(t.category !== 'special') total += val;
              const tr = document.createElement('tr');
              tr.innerHTML = `<td class="px-4 py-2 text-slate-300">${t.name}</td><td class="px-4 py-2 text-slate-400 text-xs uppercase">${t.category}</td><td class="px-4 py-2 text-right text-white font-bold">${val} / ${t.maxScore}</td>`;
              tbody.appendChild(tr);
          });
          document.getElementById('check-total-score').textContent = total;
      };

      // --- LOGIC: GRADE REPORT ---
      window.renderGradeReport = function() {
          const cid = document.getElementById('report-class').value;
          const tbody = document.getElementById('report-table-body');
          tbody.innerHTML = '';
          if(!cid) return;
          const list = dataState.students.filter(s => s.classId == cid).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          const tasks = dataState.tasks.filter(t => t.classId == cid);
          
          list.forEach((s, idx) => {
              const getSum = (cat) => {
                  let sum = 0;
                  tasks.filter(t => t.category === cat).forEach(t => {
                      const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                      sum += sc ? Number(sc.score) : 0;
                  });
                  return sum;
              };
              const accum = getSum('accum');
              const mid = getSum('midterm');
              const final = getSum('final');
              const special = getSum('special');
              const total = accum + mid + final;
              
              const tr = document.createElement('tr');
              tr.className = "hover:bg-slate-800/30";
              tr.innerHTML = `
                  <td class="text-center text-slate-500">${s.no||idx+1}</td>
                  <td class="px-2 py-3 text-white text-xs">${s.name}</td>
                  <td class="text-center text-amber-500">${accum}</td>
                  <td class="text-center text-blue-400">${mid}</td>
                  <td class="text-center text-purple-400">${final}</td>
                  <td class="text-center font-bold text-white bg-slate-800/20">${total}</td>
                  <td class="text-center text-slate-300 font-bold">${calGrade(total)}</td>
                  <td class="text-center text-pink-400 bg-pink-900/10">${special}</td>
              `;
              tbody.appendChild(tr);
          });
      };
      function calGrade(s) {
          if(s>=80) return 4; if(s>=75) return 3.5; if(s>=70) return 3; if(s>=65) return 2.5;
          if(s>=60) return 2; if(s>=55) return 1.5; if(s>=50) return 1; return 0;
      }
      window.exportGradeCSV = function() {
          const rows = document.querySelectorAll('#report-table-body tr');
          let csv = "\uFEFFNo,Name,Accum,Mid,Final,Total,Grade,Special\n";
          rows.forEach(r => {
              csv += Array.from(r.querySelectorAll('td')).map(d=>`"${d.innerText}"`).join(',') + "\n";
          });
          downloadCSV(csv, "grade_report.csv");
      };

      // --- LOGIC: ATTENDANCE MATRIX ---
      window.renderAttReportMatrix = function() {
          const cid = document.getElementById('report-att-class').value;
          const month = document.getElementById('report-att-month').value;
          const tbody = document.getElementById('att-matrix-body');
          const thead = document.getElementById('att-matrix-header');
          tbody.innerHTML=''; thead.innerHTML='';
          if(!cid||!month) return;
          
          let logs = dataState.attendance.filter(a => a.classId == cid && a.date.startsWith(month));
          let dates = [...new Set(logs.map(a=>a.date.split('T')[0]))].sort();
          window.curAttDates = dates;
          
          let h = `<th class="px-4 py-3 bg-slate-800 sticky left-0 z-20 border-r border-slate-700 w-10 text-center">#</th><th class="px-4 py-3 bg-slate-800 sticky left-[40px] z-20 border-r border-slate-700 min-w-[150px]">‡∏ä‡∏∑‡πà‡∏≠</th>`;
          dates.forEach(d => h+=`<th class="px-2 py-3 text-center bg-slate-800 border-b border-slate-700 min-w-[40px]">${d.split('-')[2]}</th>`);
          thead.innerHTML = h;
          
          const list = dataState.students.filter(s=>s.classId==cid).sort((a,b)=>(Number(a.no)||0)-(Number(b.no)||0));
          list.forEach(s => {
              let row = `<td class="px-4 py-2 text-center bg-slate-900 sticky left-0 z-10 border-r border-slate-800 text-slate-400">${s.no||'-'}</td><td class="px-4 py-2 bg-slate-900 sticky left-[40px] z-10 border-r border-slate-800 text-white">${s.name}</td>`;
              dates.forEach(d => {
                  const log = dataState.attendance.find(a => a.studentId==s.id && a.date.startsWith(d));
                  let t='-', c='text-slate-600';
                  if(log){ if(log.status=='‡∏°‡∏≤'){t='‚úî';c='text-green-500 font-bold';} else if(log.status=='‡∏•‡∏≤'){t='‡∏•';c='text-yellow-500';} else if(log.status=='‡∏Ç‡∏≤‡∏î'){t='‡∏Ç';c='text-red-500';} }
                  row += `<td class="px-2 py-2 text-center border-b border-slate-800 ${c}">${t}</td>`;
              });
              const tr=document.createElement('tr'); tr.innerHTML=row; tbody.appendChild(tr);
          });
      };
      window.exportMatrixCSV = function() {
          if(!window.curAttDates) return;
          let csv = "\uFEFFNo,Name," + window.curAttDates.join(',') + "\n";
          const rows = document.querySelectorAll('#att-matrix-body tr');
          rows.forEach(r => {
             csv += Array.from(r.querySelectorAll('td')).map(d=>`"${d.innerText}"`).join(',') + "\n";
          });
          downloadCSV(csv, "att_matrix.csv");
      };

      // --- STUDENT ---
      window.handleStudentLogin = function() {
          const c = document.getElementById('student-login-id').value.trim();
          const s = dataState.students.find(x => x.code == c);
          if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
          document.getElementById('student-login-wrapper').classList.add('hidden');
          document.getElementById('student-dashboard').classList.remove('hidden');
          document.getElementById('std-dash-name').textContent = s.name;
          document.getElementById('std-dash-id').textContent = "ID: "+s.code;
          
          // Score
          const sb = document.getElementById('std-score-body'); sb.innerHTML='';
          let sum=0;
          dataState.tasks.filter(t=>t.classId==s.classId).forEach(t=>{
              const sc = dataState.scores.find(x=>x.studentId==s.id && x.taskId==t.id);
              const v = sc ? Number(sc.score) : 0;
              if(t.category!='special') sum+=v;
              const tr=document.createElement('tr'); tr.innerHTML=`<td class="px-3 py-2 text-slate-300">${t.name}</td><td class="px-3 py-2 text-right font-bold text-white">${v}/${t.maxScore}</td>`;
              sb.appendChild(tr);
          });
          document.getElementById('std-dash-score').textContent = sum;
          
          // Att
          const ab = document.getElementById('std-att-body'); ab.innerHTML='';
          const atts = dataState.attendance.filter(a=>a.studentId==s.id).sort((a,b)=>b.date.localeCompare(a.date));
          let p=0;
          atts.forEach(a=>{
              if(a.status=='‡∏°‡∏≤') p++;
              const c=a.status=='‡∏°‡∏≤'?'text-green-400':(a.status=='‡∏•‡∏≤'?'text-yellow-400':'text-red-400');
              const tr=document.createElement('tr'); tr.innerHTML=`<td class="px-3 py-2 text-slate-400">${formatThaiDate(a.date.split('T')[0])}</td><td class="px-3 py-2 text-center font-bold ${c}">${a.status}</td>`;
              ab.appendChild(tr);
          });
          document.getElementById('std-dash-att').textContent = atts.length ? Math.round((p/atts.length)*100)+"%" : "0%";
      };
      window.logoutStudent = function() {
          document.getElementById('student-dashboard').classList.add('hidden');
          document.getElementById('student-login-wrapper').classList.remove('hidden');
          document.getElementById('student-login-id').value='';
      };

      // Utils
      function switchMainTab(t) {
          document.getElementById('section-admin').classList.add('hidden');
          document.getElementById('section-student').classList.add('hidden');
          document.getElementById('tab-btn-admin').className="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all";
          document.getElementById('tab-btn-student').className="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all";
          if(t=='admin'){
              document.getElementById('section-admin').classList.remove('hidden');
              document.getElementById('tab-btn-admin').className="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all";
          } else {
              document.getElementById('section-student').classList.remove('hidden');
              document.getElementById('tab-btn-student').className="px-5 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 shadow-lg transition-all";
              document.getElementById('student-login-id').focus();
          }
      }
      function switchAdminSubTab(t) {
          document.querySelectorAll('.admin-panel').forEach(p=>p.classList.add('hidden'));
          document.getElementById(`admin-panel-${t}`).classList.remove('hidden');
          document.querySelectorAll('.menu-btn').forEach(b=>{b.classList.remove('bg-red-800/80','text-white','shadow'); b.classList.add('text-slate-400');});
          document.getElementById(`menu-${t}`).classList.remove('text-slate-400');
          document.getElementById(`menu-${t}`).classList.add('bg-red-800/80','text-white','shadow');
          if(t=='attendance') renderLiveRoster();
      }
      async function saveAndRefresh(p) {
          if(p.action=='addStudent') dataState.students.push(p);
          if(p.action=='addSubject') dataState.subjects.push(p); // Add to local
          if(p.action=='addClass') dataState.classes.push(p); // Add to local
          await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify(p) });
      }
      function downloadCSV(csv,n) {
          const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"})); l.download=n; l.click();
      }
  </script>
 </body>
</html>
