<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <title>ChineseClass Tracker Pro V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
      body { font-family: 'Sarabun', sans-serif; }
      @view-transition { navigation: auto; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      .fade-enter { opacity: 0; transform: translateY(10px); }
      .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
  </style>
 </head>
 <body class="w-full h-full bg-slate-950 text-slate-200">
  <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center">
   <div class="app-wrapper w-full max-w-7xl my-2 md:my-4 mx-2 rounded-2xl bg-slate-900/90 shadow-2xl border border-slate-800 flex flex-col relative overflow-hidden">
    
    <header class="w-full px-6 py-4 border-b border-slate-800 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-slate-900 z-10">
     <div class="flex items-center gap-4">
      <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="School Logo" class="h-14 w-14 object-contain drop-shadow-md hover:scale-105 transition-transform bg-white/10 rounded-full p-1">
      <div>
        <h1 class="text-2xl font-bold text-white tracking-wide">ChineseClass <span class="text-red-500">System</span></h1>
        <p class="text-slate-400 text-xs">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô ‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
      </div>
     </div>
     <nav class="inline-flex rounded-full bg-slate-950 p-1 border border-slate-800">
        <button id="tab-admin" type="button" class="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all"> üë®‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π (Admin) </button> 
        <button id="tab-student" type="button" class="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all"> üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô </button>
     </nav>
    </header>

    <main class="flex-1 w-full px-4 md:px-6 pb-6 overflow-y-auto">
     <div class="w-full max-w-6xl mx-auto mt-6 flex flex-col gap-6">
      
      <section id="panel-admin" class="flex flex-col gap-5">
       
        <div id="admin-login-section" class="flex flex-col items-center justify-center py-10 gap-6">
        <div class="bg-slate-800/50 p-8 rounded-2xl border border-red-900/30 w-full max-w-sm shadow-xl backdrop-blur-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-amber-500"></div>
            
            <div class="flex justify-center mb-5">
                <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Teacher Logo" class="w-28 h-28 object-contain drop-shadow-xl hover:scale-105 transition-transform bg-white/5 rounded-full p-2 border border-slate-700">
            </div>

            <h2 class="text-xl font-bold text-white text-center mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
            
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input id="admin-username" type="text" class="w-full rounded-lg border border-slate-600 bg-slate-900/80 text-white px-4 py-2.5 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all">
                </div>
                <div>
                    <label class="text-xs text-slate-400 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="admin-password" type="password" class="w-full rounded-lg border border-slate-600 bg-slate-900/80 text-white px-4 py-2.5 focus:ring-2 focus:ring-red-500 outline-none transition-all">
                </div>
                <button type="submit" class="w-full py-3 rounded-lg bg-red-700 hover:bg-red-600 text-white font-bold shadow-lg shadow-red-900/40 transition-all transform active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            <p id="admin-login-status" class="text-xs text-center mt-4 text-amber-400 min-h-[1.5em]"></p>
        </div>
       </div>

       <div id="admin-content-section" class="hidden flex flex-col gap-5">
        
        <div class="flex items-center justify-between bg-slate-800/40 px-4 py-3 rounded-xl border border-slate-700/50">
         <div class="flex items-center gap-3">
             <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
             <span class="text-sm font-medium text-slate-300">ADMIN ONLINE</span>
         </div>
         <button id="admin-logout-button" class="text-xs px-3 py-1.5 rounded border border-red-500/30 text-red-300 hover:bg-red-900/20">Log Out</button>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 bg-slate-900/50 p-1.5 rounded-xl border border-slate-800">
            <button onclick="switchAdminTab('basic')" id="menu-basic" class="menu-btn bg-red-800/80 text-white shadow">üìÇ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button> 
            <button onclick="switchAdminTab('scan')" id="menu-scan" class="menu-btn text-slate-400 hover:text-white">üì∏ ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button onclick="switchAdminTab('attendance')" id="menu-attendance" class="menu-btn text-slate-400 hover:text-white">üìÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan)</button>
            <button onclick="switchAdminTab('check')" id="menu-check" class="menu-btn text-slate-400 hover:text-white">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button> 
            <button onclick="switchAdminTab('report')" id="menu-report" class="menu-btn text-slate-400 hover:text-white">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•</button>
        </div>

        <section id="admin-panel-basic" class="admin-panel bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
             <div class="space-y-4">
                 <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                    <form id="form-subject" class="flex gap-2 items-end">
                        <div class="flex-1"><label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label><input id="subject-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none" placeholder="‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô ‡∏õ.5"></div>
                        <button type="submit" class="bg-amber-600 text-white px-4 py-2 rounded text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </form>
                 </div>
                 <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                    <form id="form-class" class="flex gap-2 items-end">
                        <div class="flex-1"><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input id="class-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none" placeholder="‡∏õ.5/1"></div>
                        <div class="w-1/3"><label class="text-xs text-slate-400">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="class-subject-ref" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm text-white outline-none"></select></div>
                        <button type="submit" class="bg-amber-600 text-white px-4 py-2 rounded text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </form>
                 </div>
             </div>
             <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                <h4 class="text-sm font-semibold text-white mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                <form id="form-student" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á</label><select id="student-class" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none"></select></div>
                        <div><label class="text-xs text-slate-400">Barcode</label><input id="student-id" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none" placeholder="66001"></div>
                    </div>
                    <div><label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="student-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none"></div>
                    <button type="submit" class="w-full bg-amber-600 text-white py-2 rounded text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </form>
             </div>
          </div>

          <div class="bg-slate-800/60 p-5 rounded-xl border border-slate-700">
            <h4 class="text-sm font-bold text-red-300 mb-4 border-b border-slate-700 pb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö (Task Creation)</h4>
            <form id="form-task" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                <div class="md:col-span-2"><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="task-class" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none"></select></div>
                
                <div class="md:col-span-2">
                    <label class="text-xs text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="task-category" class="w-full bg-slate-900 border border-amber-500/50 text-amber-300 rounded px-2 py-2 text-xs outline-none font-semibold">
                        <option value="accum">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (60)</option>
                        <option value="midterm">üìù ‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</option>
                        <option value="final">üéì ‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</option>
                    </select>
                </div>
                
                <div id="chapter-wrapper" class="md:col-span-2">
                    <label class="text-xs text-slate-400">‡∏ö‡∏ó‡∏ó‡∏µ‡πà (‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</label>
                    <select id="task-chapter" class="w-full bg-slate-900 border border-slate-600 text-white rounded px-2 py-2 text-xs outline-none">
                        <option value="1">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                        <option value="2">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                        <option value="3">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                        <option value="4">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                        <option value="5">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 5 (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                        <option value="6">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 6 (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                    </select>
                </div>

                <div class="md:col-span-4"><label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô/‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢</label><input id="task-name" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏±‡∏î‡∏à‡∏µ‡∏ô‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1"></div>
                <div class="md:col-span-1"><label class="text-xs text-slate-400">‡πÄ‡∏ï‡πá‡∏°</label><input id="task-max-score" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none text-center" value="10"></div>
                <div class="md:col-span-1"><button type="submit" class="w-full bg-red-700 hover:bg-red-600 text-white py-2 rounded text-xs font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á</button></div>
            </form>
            <div class="mt-2 text-[10px] text-slate-400">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            <div class="mt-6 border-t border-slate-700 pt-4">
                <h4 class="text-sm font-bold text-slate-300 mb-3">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏•‡∏¥‡∏Å ‚úèÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</h4>
                <div class="overflow-x-auto bg-slate-900/50 rounded-lg border border-slate-700/50 max-h-60 overflow-y-auto">
                    <table class="min-w-full text-xs text-left text-slate-400">
                        <thead class="bg-slate-800 text-slate-300 sticky top-0">
                            <tr>
                                <th class="px-3 py-2">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                                <th class="px-3 py-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th class="px-3 py-2 text-center">‡πÄ‡∏ï‡πá‡∏°</th>
                                <th class="px-3 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="task-management-body" class="divide-y divide-slate-700/50">
                            <tr><td colspan="4" class="px-3 py-4 text-center text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
        </section>
<div id="edit-task-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h3>
            <form id="form-edit-task" class="space-y-3">
                <input type="hidden" id="edit-task-id">
                <input type="hidden" id="edit-task-class">
                <input type="hidden" id="edit-task-subject">
                
                <div>
                    <label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
                    <input id="edit-task-name" class="w-full bg-slate-950 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-amber-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="edit-task-category" class="w-full bg-slate-950 border border-slate-600 rounded px-2 py-2 text-sm text-white outline-none">
                            <option value="accum">‚≠ê ‡πÄ‡∏Å‡πá‡∏ö (60)</option>
                            <option value="midterm">üìù ‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</option>
                            <option value="final">üéì ‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</option>
                        </select>
                    </div>
                    <div id="edit-chapter-wrapper">
                        <label class="text-xs text-slate-400">‡∏ö‡∏ó‡∏ó‡∏µ‡πà</label>
                        <select id="edit-task-chapter" class="w-full bg-slate-950 border border-slate-600 rounded px-2 py-2 text-sm text-white outline-none">
                            <option value="0">-</option>
                            <option value="1">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</option>
                            <option value="2">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</option>
                            <option value="3">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</option>
                            <option value="4">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4</option>
                            <option value="5">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 5</option>
                            <option value="6">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 6</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
                        <input id="edit-task-max" type="number" class="w-full bg-slate-950 border border-slate-600 rounded px-3 py-2 text-sm text-white text-center focus:border-amber-500 outline-none">
                    </div>
                    <div>
                         <label class="text-xs text-slate-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                         <input id="edit-task-date" type="date" class="w-full bg-slate-950 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                    </div>
                </div>

                <div class="pt-4 grid grid-cols-2 gap-3">
                    <button type="button" onclick="closeModal('edit-task-modal')" class="py-2 rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 font-medium text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-500 font-bold text-sm shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </form>
        </div>
    </div>
        <section id="admin-panel-scan" class="admin-panel hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <span class="text-2xl">üì∏</span>
                <h3 class="text-lg font-bold text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡∏™‡πà‡∏á‡∏™‡∏°‡∏∏‡∏î</h3>
              </div>
              
              <div class="flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700">
                  <button id="mode-score" class="px-3 py-1 text-xs font-bold rounded bg-red-700 text-white transition-all">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                  <button id="mode-submit" class="px-3 py-1 text-xs font-bold rounded text-slate-400 hover:text-white transition-all">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô/‡∏™‡∏°‡∏∏‡∏î (‡πÄ‡∏£‡πá‡∏ß)</button>
              </div>
          </div>

          <div class="bg-slate-900/80 px-4 py-3 rounded-lg border border-slate-700 flex items-center justify-between">
             <div class="flex items-center gap-3">
                 <div class="w-3 h-3 rounded-full bg-gray-500" id="scan-indicator-light"></div>
                 <div>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Current Task</p>
                    <p id="current-task-display" class="text-sm font-bold text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Scan QR Task)</p>
                 </div>
             </div>
             <p id="mode-status-text" class="text-xs text-red-400 font-bold border border-red-500/30 px-2 py-1 rounded">‡πÇ‡∏´‡∏°‡∏î: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
          </div>

          <div class="relative group">
             <div class="absolute -inset-1 bg-gradient-to-r from-red-600 to-amber-500 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
             <input id="scan-input" type="text" class="relative block w-full rounded-xl border-2 border-slate-700 bg-slate-900 text-white px-6 py-6 text-2xl text-center font-mono tracking-[0.2em] focus:outline-none focus:border-red-500 placeholder-slate-600 transition-all" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î" autocomplete="off">
          </div>
          <p id="scan-feedback" class="text-sm text-center text-slate-400 min-h-[1.5em] font-medium"></p>
        </section>

        <section id="admin-panel-attendance" class="admin-panel hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìÖ</span>
                    <h3 class="text-lg font-bold text-white">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-slate-800/60 p-5 rounded-xl border border-slate-700">
                    <div class="flex gap-2 mb-4">
                        <select id="att-class-select" class="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white flex-1"></select>
                        <input id="att-date-input" type="date" class="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
                    </div>
                    <input id="att-scan-input" type="text" class="w-full bg-slate-900 border-2 border-slate-600 rounded-xl px-4 py-4 text-xl text-center text-white focus:border-green-500 outline-none mb-2" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠">
                    <p id="att-feedback" class="text-center text-sm text-slate-400 min-h-[1.5em]"></p>
                </div>

                <div class="bg-slate-800/60 p-5 rounded-xl border border-slate-700 overflow-hidden flex flex-col">
                    <h4 class="text-sm font-bold text-white mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
                    <div class="flex-1 overflow-y-auto max-h-[200px]">
                        <table class="w-full text-sm text-left text-slate-300">
                            <thead class="text-xs uppercase bg-slate-700/50 text-slate-400 sticky top-0">
                                <tr><th class="px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th><th class="px-2 py-1 text-right">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
                            </thead>
                            <tbody id="att-summary-body" class="divide-y divide-slate-700/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="admin-panel-check" class="admin-panel hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
            <div class="flex flex-col md:flex-row gap-3 items-center bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                <select id="check-subject-filter" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-white outline-none"></select>
                <input id="check-student-input" type="text" class="flex-1 w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™...">
                <button id="btn-check-student" class="bg-amber-600 text-white px-6 py-3 rounded-lg font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            </div>
            <div id="check-result" class="hidden flex flex-col gap-5">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-red-900/50 flex justify-between items-center">
                    <div>
                        <h2 id="check-name" class="text-2xl font-bold text-white">-</h2>
                        <p id="check-class" class="text-amber-400">-</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400">‡∏£‡∏ß‡∏° (100)</p>
                        <p id="check-total-score" class="text-3xl font-bold text-white">0</p>
                    </div>
                </div>
                <div class="overflow-hidden bg-slate-800/40 rounded-xl border border-slate-700">
                    <table class="min-w-full text-sm text-slate-300">
                        <thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400">
                            <tr><th class="px-4 py-3 text-left">‡∏´‡∏°‡∏ß‡∏î/‡∏ö‡∏ó‡∏ó‡∏µ‡πà</th><th class="px-4 py-3 text-left">‡∏á‡∏≤‡∏ô</th><th class="px-4 py-3 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr>
                        </thead>
                        <tbody id="check-table-body" class="divide-y divide-slate-700/50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="admin-panel-report" class="admin-panel hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
             <div class="flex items-center justify-between">
                 <h3 class="text-lg font-bold text-white">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏• (Normalized)</h3>
                 <button id="btn-export-csv" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">üìÑ Export CSV</button>
             </div>
             <div class="grid grid-cols-2 gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                <div><label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label><select id="report-subject" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none"></select></div>
                <div><label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="report-class" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none"></select></div>
             </div>
             <div class="overflow-x-auto bg-slate-800/40 rounded-xl border border-slate-700">
                <table class="min-w-full text-sm text-slate-300">
                    <thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400">
                        <tr>
                            <th class="px-4 py-3 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                            <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th class="px-2 py-3 text-center text-amber-500">‡∏ö‡∏ó1 (10)</th>
                            <th class="px-2 py-3 text-center text-amber-500">‡∏ö‡∏ó2 (10)</th>
                            <th class="px-2 py-3 text-center text-amber-500">‡∏ö‡∏ó3 (10)</th>
                            <th class="px-2 py-3 text-center text-amber-500">‡∏ö‡∏ó4 (10)</th>
                            <th class="px-2 py-3 text-center text-amber-500">‡∏ö‡∏ó5 (10)</th>
                            <th class="px-2 py-3 text-center text-amber-500">‡∏ö‡∏ó6 (10)</th>
                            <th class="px-2 py-3 text-center text-blue-400">‡∏Å‡∏•‡∏≤‡∏á (20)</th>
                            <th class="px-2 py-3 text-center text-purple-400">‡∏õ‡∏•‡∏≤‡∏¢ (30)</th>
                            <th class="px-2 py-3 text-center text-white font-bold">‡∏£‡∏ß‡∏°</th>
                            <th class="px-2 py-3 text-center">‡πÄ‡∏Å‡∏£‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-slate-700/50"></tbody>
                </table>
             </div>
        </section>

       </div>
      </section>

      <section id="panel-student" class="hidden flex flex-col gap-5 transition-all duration-500">
          <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-10 gap-6">
            <div class="text-center space-y-2">
                <div class="flex justify-center mb-5">
                    <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Student Logo" class="w-28 h-28 object-contain drop-shadow-xl hover:scale-105 transition-transform bg-white/5 rounded-full p-2 border border-slate-700">
                </div>
                <h2 class="text-2xl font-bold text-white">üéì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <p class="text-slate-400 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            </div>
            <form id="student-login-form" class="w-full max-w-xs relative">
                <input id="student-login-id" type="text" class="w-full bg-slate-900/80 border-2 border-slate-700 rounded-xl px-5 py-4 text-center text-xl tracking-widest text-white focus:border-red-500 focus:ring-4 focus:ring-red-500/20 outline-none transition-all placeholder-slate-600" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Barcode)">
                <button type="submit" class="w-full mt-4 bg-red-700 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
            <p id="student-login-error" class="text-sm text-red-400 font-medium min-h-[1.5em] text-center"></p>
          </div>

          <div id="student-dashboard" class="hidden flex flex-col gap-6">
             <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4 shadow-lg">
                 <div>
                     <p class="text-xs text-slate-400 uppercase text-center md:text-left">Welcome back</p>
                     <h2 id="stu-name-display" class="text-xl md:text-2xl font-bold text-white text-center md:text-left">-</h2>
                     <p id="stu-class-display" class="text-sm text-amber-400 text-center md:text-left">-</p>
                 </div>
                 <button id="btn-student-logout" class="px-4 py-2 border border-slate-600 text-slate-300 rounded-lg hover:bg-slate-700 text-xs font-bold transition-colors w-full md:w-auto">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
             </div>

             <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                 <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center">
                     <p class="text-xs text-slate-400 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (60)</p>
                     <p id="stu-score-accum" class="text-xl font-bold text-amber-400">-</p>
                     <p class="text-[10px] text-slate-500">‡∏£‡∏ß‡∏° 6 ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                 </div>
                 <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center">
                    <p class="text-xs text-slate-400 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</p>
                    <p id="stu-score-mid" class="text-xl font-bold text-blue-400">-</p>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center">
                    <p class="text-xs text-slate-400 mb-1">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</p>
                    <p id="stu-score-final" class="text-xl font-bold text-purple-400">-</p>
                </div>
                <div class="bg-gradient-to-br from-red-900 to-slate-900 p-4 rounded-xl border border-red-500/30 text-center relative overflow-hidden group">
                    <div class="absolute inset-0 bg-red-600/10 group-hover:bg-red-600/20 transition-all"></div>
                    <p class="text-xs text-red-200 mb-1 relative z-10">‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <p id="stu-grade-total" class="text-3xl font-bold text-white relative z-10">-</p>
                </div>
             </div>

             <div class="bg-slate-800/30 rounded-2xl border border-slate-700/50 overflow-hidden">
                 <div class="px-5 py-3 border-b border-slate-700/50 bg-slate-800/50">
                     <h3 class="text-sm font-bold text-white">üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</h3>
                 </div>
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-slate-300">
                        <thead class="bg-slate-900/50 text-xs uppercase text-slate-400">
                            <tr>
                                <th class="px-4 py-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="px-4 py-3 text-left">‡∏á‡∏≤‡∏ô</th>
                                <th class="px-4 py-3 text-center">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                                <th class="px-4 py-3 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody id="stu-task-body" class="divide-y divide-slate-700/30"></tbody>
                    </table>
                 </div>
             </div>
          </div>
      </section>

     </div>
    </main>

    <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <p class="text-slate-400 text-sm mb-2 text-center" id="modal-student-name"></p>
            <div class="relative">
                <input id="modal-score-input" type="number" class="w-full bg-slate-950 border-2 border-red-500 rounded-xl px-4 py-4 text-3xl text-center text-white font-bold focus:outline-none">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm">/ <span id="modal-max-score">10</span></span>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="closeModal('score-modal')" class="py-2 rounded-lg bg-slate-800 text-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-modal-save" class="py-2 rounded-lg bg-red-700 text-white font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="att-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-xs shadow-2xl text-center">
            <h3 class="text-lg font-bold text-white mb-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
            <p id="att-modal-name" class="text-amber-400 text-lg font-semibold mb-6">-</p>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="saveAttendance('‡∏°‡∏≤')" class="py-3 rounded-xl bg-green-600 text-white font-bold text-lg hover:bg-green-500">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Present)</button>
                <button onclick="saveAttendance('‡∏•‡∏≤')" class="py-3 rounded-xl bg-yellow-600 text-white font-bold text-lg hover:bg-yellow-500">‚ö†Ô∏è ‡∏•‡∏≤ (Leave)</button>
                <button onclick="saveAttendance('‡∏Ç‡∏≤‡∏î')" class="py-3 rounded-xl bg-red-600 text-white font-bold text-lg hover:bg-red-500">‚ùå ‡∏Ç‡∏≤‡∏î (Absent)</button>
            </div>
            <button onclick="closeModal('att-modal')" class="mt-4 text-slate-500 text-xs underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

   </div>
  </div>

  <script>
      // ‚ö†Ô∏è‚ö†Ô∏è URL Web App ‚ö†Ô∏è‚ö†Ô∏è
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec";

      let dataState = { subjects:[], classes:[], students:[], tasks:[], scores:[], attendance:[] };
      let currentScanTask = null;
      let pendingStudent = null;
      let scanMode = 'score'; 

      window.addEventListener('DOMContentLoaded', () => {
          document.getElementById('att-date-input').valueAsDate = new Date();
          syncData();
          initEventListeners();
      });

      async function syncData() {
          try {
             const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
             const json = await res.json();
             if(json) { dataState = json; refreshUI(); }
          } catch(e) { console.error(e); }
      }

      function refreshUI() {
          const populate = (id, arr, filterFn) => {
              const el = document.getElementById(id);
              el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
              const items = filterFn ? arr.filter(filterFn) : arr;
              items.forEach(i => {
                  const opt = document.createElement('option');
                  opt.value = i.id;
                  opt.textContent = i.name;
                  el.appendChild(opt);
              });
          };

          populate('class-subject-ref', dataState.subjects);
          populate('task-class', dataState.classes);
          populate('student-class', dataState.classes); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° student-class ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          populate('check-subject-filter', dataState.subjects);
          populate('report-subject', dataState.subjects);
          populate('att-class-select', dataState.classes);
          
          document.getElementById('report-subject').onchange = (e) => {
               populate('report-class', dataState.classes, c => c.subjectId == e.target.value);
               renderReportTable();
          };
          document.getElementById('report-class').onchange = renderReportTable;

          // QR List (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          const qrList = document.getElementById('task-list-qr');
          // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô HTML ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏≤ div id="task-list-qr" ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ó‡∏ô ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà error)
      }

      function initEventListeners() {
          // Tab Switchers
          document.getElementById('tab-admin').onclick = () => { document.getElementById('panel-admin').classList.remove('hidden'); document.getElementById('panel-student').classList.add('hidden'); };
          document.getElementById('tab-student').onclick = () => { document.getElementById('panel-student').classList.remove('hidden'); document.getElementById('panel-admin').classList.add('hidden'); };
          
          // Login
          document.getElementById('admin-login-form').onsubmit = async (e) => {
              e.preventDefault();
              const u = document.getElementById('admin-username').value;
              const p = document.getElementById('admin-password').value;
              const status = document.getElementById('admin-login-status');
              try {
                  const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: u, password: p }) });
                  const json = await res.json();
                  if(json.status === 'success') {
                      document.getElementById('admin-login-section').classList.add('hidden');
                      document.getElementById('admin-content-section').classList.remove('hidden');
                  } else { status.textContent = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; }
              } catch(err) { status.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"; }
          };

          // Menu Buttons
          window.switchAdminTab = (tab) => {
              document.querySelectorAll('.menu-btn').forEach(b => {
                  b.classList.remove('bg-red-800/80', 'text-white', 'shadow');
                  b.classList.add('text-slate-400');
              });
              document.getElementById(`menu-${tab}`).classList.remove('text-slate-400');
              document.getElementById(`menu-${tab}`).classList.add('bg-red-800/80', 'text-white', 'shadow');
              
              document.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden'));
              document.getElementById(`admin-panel-${tab}`).classList.remove('hidden');

              if(tab === 'scan') document.getElementById('scan-input').focus();
              if(tab === 'attendance') document.getElementById('att-scan-input').focus();
          };

          // Forms
          document.getElementById('form-subject').onsubmit = (e) => handleForm(e, 'addSubject', { name: document.getElementById('subject-name').value, id: Date.now() });
          document.getElementById('form-class').onsubmit = (e) => handleForm(e, 'addClass', { name: document.getElementById('class-name').value, subjectId: document.getElementById('class-subject-ref').value, id: Date.now() });
          document.getElementById('form-student').onsubmit = (e) => handleForm(e, 'addStudent', { name: document.getElementById('student-name').value, code: document.getElementById('student-id').value, classId: document.getElementById('student-class').value, id: Date.now(), email:'' });
          
          document.getElementById('form-task').onsubmit = (e) => {
              e.preventDefault();
              const cls = document.getElementById('task-class').value;
              const clObj = dataState.classes.find(c => c.id == cls);
              const payload = { 
                  action: 'addTask', id: Date.now(), 
                  name: document.getElementById('task-name').value, 
                  classId: cls, 
                  subjectId: clObj ? clObj.subjectId : 0,
                  category: document.getElementById('task-category').value,
                  chapter: document.getElementById('task-category').value === 'accum' ? document.getElementById('task-chapter').value : 0,
                  maxScore: document.getElementById('task-max-score').value,
                  dueDateISO: new Date().toISOString()
              };
              saveAndRefresh(payload);
              alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
              // Refresh table after add
              renderTaskManagementTable(cls);
          };

          // Listeners ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
          document.getElementById('task-category').onchange = (e) => {
              const el = document.getElementById('chapter-wrapper');
              if(e.target.value === 'accum') el.classList.remove('hidden'); else el.classList.add('hidden');
          };

          const scanInput = document.getElementById('scan-input');
          scanInput.onkeydown = (e) => { if(e.key === 'Enter') { handleScan(scanInput.value.trim()); scanInput.value=''; } };

          document.getElementById('mode-score').onclick = () => setScanMode('score');
          document.getElementById('mode-submit').onclick = () => setScanMode('submit');
          document.getElementById('btn-modal-save').onclick = saveScoreFromModal;
          
          const attInput = document.getElementById('att-scan-input');
          attInput.onkeydown = (e) => { if(e.key === 'Enter') { handleAttScan(attInput.value.trim()); attInput.value=''; } };

          document.getElementById('btn-check-student').onclick = performCheck;
          document.getElementById('btn-export-csv').onclick = exportCSV;
          
          document.getElementById('student-login-form').addEventListener('submit', handleStudentLogin);
          document.getElementById('btn-student-logout').addEventListener('click', () => location.reload());   
          
          // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô (Task Edit Listeners) ---
          document.getElementById('task-class').addEventListener('change', (e) => {
              renderTaskManagementTable(e.target.value);
          });
          
          document.getElementById('edit-task-category').addEventListener('change', (e) => {
               const el = document.getElementById('edit-chapter-wrapper');
               if(e.target.value === 'accum') el.style.visibility = 'visible'; else el.style.visibility = 'hidden';
          });

          document.getElementById('form-edit-task').addEventListener('submit', handleEditTaskSubmit);
      } // ‡∏à‡∏ö initEventListeners

      // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Functions) ---
      function renderTaskManagementTable(classId) {
          const tbody = document.getElementById('task-management-body');
          tbody.innerHTML = '';
          
          if(!classId) {
              tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-slate-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
              return;
          }

          const tasks = dataState.tasks.filter(t => t.classId == classId).slice().reverse(); 
          
          if(tasks.length === 0) {
               tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>';
               return;
          }

          tasks.forEach(t => {
              let catLabel = t.category;
              if(t.category === 'accum') catLabel = `‡πÄ‡∏Å‡πá‡∏ö (‡∏ö‡∏ó ${t.chapter})`;
              
              const tr = document.createElement('tr');
              tr.className = "hover:bg-slate-800/50 transition-colors";
              tr.innerHTML = `
                  <td class="px-3 py-2 font-medium text-white">${t.name} <div class="text-[10px] text-slate-500">QR: TASK:${t.id}</div></td>
                  <td class="px-3 py-2 text-slate-400">${catLabel}</td>
                  <td class="px-3 py-2 text-center text-amber-400">${t.maxScore}</td>
                  <td class="px-3 py-2 text-center">
                      <button onclick="openEditTaskModal(${t.id})" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-2 py-1 rounded text-xs flex items-center gap-1 mx-auto transition-all">
                          ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                      </button>
                  </td>
              `;
              tbody.appendChild(tr);
          });
      }

      // ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô Global function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ onclick ‡πÉ‡∏ô HTML ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
      window.openEditTaskModal = function(taskId) {
          const task = dataState.tasks.find(t => t.id == taskId);
          if(!task) return;

          document.getElementById('edit-task-id').value = task.id;
          document.getElementById('edit-task-class').value = task.classId;
          document.getElementById('edit-task-subject').value = task.subjectId;
          document.getElementById('edit-task-name').value = task.name;
          document.getElementById('edit-task-max').value = task.maxScore;
          document.getElementById('edit-task-category').value = task.category;
          document.getElementById('edit-task-chapter').value = task.chapter || 0;
          
          if(task.dueDateISO) {
             document.getElementById('edit-task-date').value = task.dueDateISO.split('T')[0];
          }

          document.getElementById('edit-task-category').dispatchEvent(new Event('change'));
          document.getElementById('edit-task-modal').classList.remove('hidden');
      };
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
      window.closeModal = function(id) {
          document.getElementById(id).classList.add('hidden');
      };

      function handleEditTaskSubmit(e) {
          e.preventDefault();
          const id = document.getElementById('edit-task-id').value;
          
          const payload = {
              action: 'editTask',
              id: id,
              name: document.getElementById('edit-task-name').value,
              classId: document.getElementById('edit-task-class').value,
              subjectId: document.getElementById('edit-task-subject').value,
              maxScore: document.getElementById('edit-task-max').value,
              category: document.getElementById('edit-task-category').value,
              chapter: document.getElementById('edit-task-category').value === 'accum' ? document.getElementById('edit-task-chapter').value : 0,
              dueDateISO: document.getElementById('edit-task-date').value ? new Date(document.getElementById('edit-task-date').value).toISOString() : ""
          };

          const idx = dataState.tasks.findIndex(t => t.id == id);
          if(idx !== -1) {
              dataState.tasks[idx] = { ...dataState.tasks[idx], ...payload };
          }

          closeModal('edit-task-modal');
          renderTaskManagementTable(payload.classId);
          saveAndRefresh(payload);
          alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      }        

      function setScanMode(mode) {
          scanMode = mode;
          document.getElementById('mode-score').className = mode==='score' ? "px-3 py-1 text-xs font-bold rounded bg-red-700 text-white" : "px-3 py-1 text-xs font-bold rounded text-slate-400";
          document.getElementById('mode-submit').className = mode==='submit' ? "px-3 py-1 text-xs font-bold rounded bg-green-700 text-white" : "px-3 py-1 text-xs font-bold rounded text-slate-400";
          
          const status = document.getElementById('mode-status-text');
          if(mode === 'score') { status.textContent = "‡πÇ‡∏´‡∏°‡∏î: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"; status.className = "text-xs text-red-400 font-bold border border-red-500/30 px-2 py-1 rounded"; }
          else { status.textContent = "‡πÇ‡∏´‡∏°‡∏î: ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡πá‡∏ß)"; status.className = "text-xs text-green-400 font-bold border border-green-500/30 px-2 py-1 rounded"; }
          document.getElementById('scan-input').focus();
      }

      async function handleForm(e, action, data) {
          e.preventDefault();
          saveAndRefresh({ action, ...data });
          e.target.reset();
      }

      async function saveAndRefresh(payload) {
          if(payload.action === 'addSubject') dataState.subjects.push(payload);
          if(payload.action === 'addClass') dataState.classes.push(payload);
          if(payload.action === 'addStudent') dataState.students.push(payload);
          if(payload.action === 'addTask') dataState.tasks.push(payload);
          if(payload.action === 'addScore') {
              const idx = dataState.scores.findIndex(s => s.studentId == payload.studentId && s.taskId == payload.taskId);
              if(idx > -1) dataState.scores[idx].score = payload.score; else dataState.scores.push({ studentId: payload.studentId, taskId: payload.taskId, score: payload.score });
          }
          if(payload.action === 'addAttendance') dataState.attendance.push(payload);

          // refreshUI(); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å refreshUI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
          await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      }

      // --- SCAN LOGIC ---
      function handleScan(code) {
          if(!code) return;
          const fb = document.getElementById('scan-feedback');
          
          if(code.toUpperCase().startsWith('TASK:')) {
              const tid = code.split(':')[1];
              const task = dataState.tasks.find(t => t.id == tid);
              if(task) {
                  currentScanTask = task;
                  document.getElementById('current-task-display').textContent = task.name;
                  document.getElementById('current-task-display').className = "text-sm font-bold text-amber-400";
                  document.getElementById('scan-indicator-light').className = "w-3 h-3 rounded-full bg-amber-500 shadow-[0_0_10px_#f59e0b]";
                  fb.textContent = "‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß"; fb.className = "text-green-400 text-sm font-bold text-center";
              }
              return;
          }

          if(!currentScanTask) { fb.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô"; fb.className = "text-amber-400 text-sm text-center"; return; }
          const s = dataState.students.find(x => x.code == code);
          if(!s) { fb.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; fb.className = "text-red-400 text-sm text-center"; return; }
          if(String(s.classId) !== String(currentScanTask.classId)) { fb.textContent = "‚ùå ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á"; fb.className = "text-red-400 text-sm text-center"; return; }

          if(scanMode === 'score') {
              pendingStudent = s;
              document.getElementById('score-modal').classList.remove('hidden');
              document.getElementById('modal-student-name').textContent = s.name;
              document.getElementById('modal-max-score').textContent = currentScanTask.maxScore;
              const exist = dataState.scores.find(x => x.studentId == s.id && x.taskId == currentScanTask.id);
              const inp = document.getElementById('modal-score-input');
              inp.value = exist ? exist.score : currentScanTask.maxScore;
              setTimeout(() => inp.select(), 100);
          } else {
              saveAndRefresh({ action: 'addScore', studentId: s.id, taskId: currentScanTask.id, score: currentScanTask.maxScore });
              fb.textContent = `‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: ${s.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`; fb.className = "text-green-400 text-sm font-bold text-center";
          }
      }

      function saveScoreFromModal() {
          const val = document.getElementById('modal-score-input').value;
          saveAndRefresh({ action: 'addScore', studentId: pendingStudent.id, taskId: currentScanTask.id, score: val });
          closeModal('score-modal');
          document.getElementById('scan-feedback').textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${pendingStudent.name}`;
          document.getElementById('scan-input').focus();
      }

      // --- ATTENDANCE LOGIC ---
      function handleAttScan(code) {
          const clsId = document.getElementById('att-class-select').value;
          if(!clsId) { alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô"); return; }
          const s = dataState.students.find(x => x.code == code && x.classId == clsId);
          if(!s) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ"); return; }
          
          pendingStudent = s;
          document.getElementById('att-modal').classList.remove('hidden');
          document.getElementById('att-modal-name').textContent = s.name;
      }

      function saveAttendance(status) {
          const clsId = document.getElementById('att-class-select').value;
          const date = document.getElementById('att-date-input').value;
          
          saveAndRefresh({ action:'addAttendance', studentId: pendingStudent.id, classId: clsId, date: date, status: status });
          closeModal('att-modal');
          
          const tr = document.createElement('tr');
          const color = status === '‡∏°‡∏≤' ? 'text-green-400' : (status === '‡∏•‡∏≤' ? 'text-yellow-400' : 'text-red-400');
          tr.innerHTML = `<td class="px-2 py-1">${pendingStudent.name}</td><td class="px-2 py-1 text-right ${color} font-bold">${status}</td>`;
          document.getElementById('att-summary-body').prepend(tr);
          document.getElementById('att-scan-input').focus();
      }

      // --- REPORT & CALC LOGIC ---
      function renderReportTable() {
          const cid = document.getElementById('report-class').value;
          const sid = document.getElementById('report-subject').value;
          const tbody = document.getElementById('report-table-body');
          tbody.innerHTML = '';
          
          if(!cid || !sid) return;

          const students = dataState.students.filter(s => s.classId == cid);
          const classTasks = dataState.tasks.filter(t => t.classId == cid && t.subjectId == sid);

          students.forEach(s => {
              let chapters = [0,0,0,0,0,0];
              for(let i=1; i<=6; i++) {
                  const tasksInChap = classTasks.filter(t => t.category === 'accum' && t.chapter == i);
                  if(tasksInChap.length > 0) {
                      let earned = 0, max = 0;
                      tasksInChap.forEach(t => {
                          const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                          earned += sc ? Number(sc.score) : 0;
                          max += Number(t.maxScore);
                      });
                      if(max > 0) chapters[i-1] = Math.round((earned / max) * 10); 
                  }
              }

              let mid=0, final=0;
              classTasks.filter(t => t.category === 'midterm').forEach(t => {
                  const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                  mid += sc ? Number(sc.score) : 0;
              });
              classTasks.filter(t => t.category === 'final').forEach(t => {
                  const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                  final += sc ? Number(sc.score) : 0;
              });

              const total = chapters.reduce((a,b)=>a+b,0) + mid + final;
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="px-4 py-3 text-slate-400 font-mono">${s.code}</td>
                <td class="px-4 py-3 text-white">${s.name}</td>
                ${chapters.map(c => `<td class="text-center text-amber-400">${c}</td>`).join('')}
                <td class="text-center text-blue-400">${mid}</td>
                <td class="text-center text-purple-400">${final}</td>
                <td class="text-center font-bold text-white text-lg">${total}</td>
                <td class="text-center text-slate-300">${calculateGrade(total)}</td>
              `;
              tbody.appendChild(tr);
          });
      }

      function calculateGrade(score) {
          if(score >= 80) return "4";
          if(score >= 75) return "3.5";
          if(score >= 70) return "3";
          if(score >= 65) return "2.5";
          if(score >= 60) return "2";
          if(score >= 55) return "1.5";
          if(score >= 50) return "1";
          return "0";
      }

      function performCheck() {
          const sid = document.getElementById('check-subject-filter').value;
          const txt = document.getElementById('check-student-input').value.trim();
          if(!sid) { alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô"); return; }

          const s = dataState.students.find(x => x.code == txt || x.name.includes(txt));
          if(!s) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"); return; }
          
          document.getElementById('check-result').classList.remove('hidden');
          document.getElementById('check-name').textContent = s.name;
          
          const tasks = dataState.tasks.filter(t => t.classId == s.classId && t.subjectId == sid);
          const tbody = document.getElementById('check-table-body');
          tbody.innerHTML = '';
          
          tasks.forEach(t => {
              const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
              const val = sc ? Number(sc.score) : 0;
              let catName = t.category;
              if(t.category === 'accum') catName = `‡∏ö‡∏ó‡∏ó‡∏µ‡πà ${t.chapter}`;
              
              const tr = document.createElement('tr');
              tr.innerHTML = `<td class="px-4 py-2 text-slate-400">${catName}</td><td class="px-4 py-2 text-white">${t.name}</td><td class="px-4 py-2 text-right">${val} / ${t.maxScore}</td>`;
              tbody.appendChild(tr);
          });
      }

      function exportCSV() {
          const cid = document.getElementById('report-class').value;
          const sid = document.getElementById('report-subject').value;
          if(!cid) return;
          
          let csv = "\uFEFFID,Name,C1,C2,C3,C4,C5,C6,Mid,Final,Total,Grade\n";
          const rows = document.querySelectorAll('#report-table-body tr');
          rows.forEach(r => {
              const cols = r.querySelectorAll('td');
              if(cols.length > 1) {
                  const data = Array.from(cols).map(c => `"${c.innerText}"`);
                  csv += data.join(',') + "\n";
              }
          });
          
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "grade_report.csv";
          link.click();
      }
      
      function handleStudentLogin(e) {
          e.preventDefault();
          const code = document.getElementById('student-login-id').value.trim();
          const err = document.getElementById('student-login-error');
          
          if(!code) { err.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; return; }

          const s = dataState.students.find(x => x.code == code);
          if(!s) { err.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"; return; }
          
          err.textContent = "";
          renderStudentDashboard(s);
      }

      function renderStudentDashboard(s) {
          document.getElementById('student-login-wrapper').classList.add('hidden');
          document.getElementById('student-dashboard').classList.remove('hidden');
          
          document.getElementById('stu-name-display').textContent = s.name;
          const cls = dataState.classes.find(c => c.id == s.classId);
          document.getElementById('stu-class-display').textContent = cls ? cls.name : "-";

          const tasks = dataState.tasks.filter(t => t.classId == s.classId);
          
          let chaptersScore = 0;
          for(let i=1; i<=6; i++) {
              const chapTasks = tasks.filter(t => t.category === 'accum' && t.chapter == i);
              if(chapTasks.length > 0) {
                  let earned = 0, max = 0;
                  chapTasks.forEach(t => {
                      const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                      earned += sc ? Number(sc.score) : 0;
                      max += Number(t.maxScore);
                  });
                  if(max > 0) chaptersScore += Math.round((earned / max) * 10);
              }
          }

          let mid = 0, final = 0;
          tasks.filter(t => t.category === 'midterm').forEach(t => {
             const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
             mid += sc ? Number(sc.score) : 0;
          });
          tasks.filter(t => t.category === 'final').forEach(t => {
             const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
             final += sc ? Number(sc.score) : 0;
          });

          const total = chaptersScore + mid + final;

          document.getElementById('stu-score-accum').textContent = chaptersScore;
          document.getElementById('stu-score-mid').textContent = mid;
          document.getElementById('stu-score-final').textContent = final;
          document.getElementById('stu-grade-total').textContent = calculateGrade(total);

          const tbody = document.getElementById('stu-task-body');
          tbody.innerHTML = '';
          const today = new Date().toISOString().split('T')[0];
          
          tasks.forEach(t => {
              const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
              const val = sc ? Number(sc.score) : 0;
              const hasScore = !!sc;
              
              let statusHTML = ''; 
              let rowClass = '';
              
              if(hasScore) { 
                  statusHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-900/30 border border-green-500/50 text-green-400 text-[10px]">‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`; 
                  rowClass = "bg-green-900/5"; 
              } 
              else if (t.dueDateISO && t.dueDateISO < today) { 
                  statusHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-900/30 border border-red-500/50 text-red-400 text-[10px]">üî¥ ‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á</span>`; 
                  rowClass = "bg-red-900/10"; 
              } 
              else { 
                  statusHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-900/30 border border-yellow-500/50 text-yellow-400 text-[10px]">üü° ‡∏£‡∏≠‡∏™‡πà‡∏á</span>`; 
              }

              let taskLabel = t.name;
              if(t.category === 'accum') taskLabel += ` <span class="text-[10px] text-slate-500">(‡∏ö‡∏ó ${t.chapter})</span>`;

              const tr = document.createElement('tr');
              tr.className = `border-b border-slate-700/30 ${rowClass}`;
              tr.innerHTML = `
                  <td class="px-4 py-3 whitespace-nowrap">${statusHTML}</td>
                  <td class="px-4 py-3 text-white">
                      <div class="font-medium text-sm">${taskLabel}</div>
                  </td>
                  <td class="px-4 py-3 text-center text-slate-400 text-xs">${t.dueDateISO ? t.dueDateISO.split('T')[0] : '-'}</td>
                  <td class="px-4 py-3 text-right font-mono text-indigo-300">
                      ${hasScore ? val : '-'}<span class="text-slate-600">/${t.maxScore}</span>
                  </td>`;
              tbody.appendChild(tr);
          });
      }
  </script>
 </body>
</html>
