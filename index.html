<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <title>ChineseClass Tracker Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
      body { font-family: 'Sarabun', sans-serif; }
      @view-transition { navigation: auto; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
 </head>
 <body class="w-full h-full bg-slate-950 text-slate-200">
  <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center">
   <div class="app-wrapper w-full max-w-6xl my-4 mx-2 md:mx-4 rounded-2xl bg-slate-900/90 shadow-2xl border border-slate-800 flex flex-col relative overflow-hidden">
    
    <header class="w-full px-6 py-4 border-b border-slate-800 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-slate-900 z-10">
     <div class="flex items-center gap-4">
      <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="School Logo" class="h-16 w-16 object-contain drop-shadow-md hover:scale-105 transition-transform bg-white/10 rounded-full p-1">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wide">ChineseClass <span class="text-red-500">Tracker</span></h1>
        <p class="text-slate-400 text-xs md:text-sm mt-0.5">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
      </div>
     </div>
     <nav class="inline-flex rounded-full bg-slate-950 p-1 border border-slate-800">
        <button id="tab-admin" type="button" class="px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-[0_0_15px_rgba(185,28,28,0.4)] transition-all duration-300"> üë®‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π (Admin) </button> 
        <button id="tab-student" type="button" class="px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all duration-300"> üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô </button>
     </nav>
    </header>

    <main class="flex-1 w-full px-4 md:px-6 pb-6 overflow-y-auto">
     <div class="w-full max-w-5xl mx-auto mt-6 flex flex-col gap-6">
      
      <section id="panel-admin" class="flex flex-col gap-5 transition-all duration-500">
       
       <div id="admin-login-section" class="flex flex-col items-center justify-center py-10 gap-6">
        <div class="bg-slate-800/50 p-8 rounded-2xl border border-red-900/30 w-full max-w-sm shadow-xl backdrop-blur-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-amber-500"></div>
            <div class="flex justify-center mb-5">
                <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Teacher Logo" class="w-28 h-28 object-contain drop-shadow-xl hover:scale-105 transition-transform bg-white/5 rounded-full p-2 border border-slate-700">
            </div>
            <h2 class="text-xl font-bold text-white text-center mb-6">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input id="admin-username" type="text" class="w-full rounded-lg border border-slate-600 bg-slate-900/80 text-white px-4 py-2.5 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all">
                </div>
                <div>
                    <label class="text-xs text-slate-400 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="admin-password" type="password" class="w-full rounded-lg border border-slate-600 bg-slate-900/80 text-white px-4 py-2.5 focus:ring-2 focus:ring-red-500 outline-none transition-all">
                </div>
                <button type="submit" class="w-full py-3 rounded-lg bg-red-700 hover:bg-red-600 text-white font-bold shadow-lg shadow-red-900/40 transition-all transform active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            <p id="admin-login-status" class="text-xs text-center mt-4 text-amber-400 min-h-[1.5em]"></p>
        </div>
       </div>

       <div id="admin-content-section" class="hidden flex flex-col gap-5">
        
        <div class="flex items-center justify-between bg-slate-800/40 px-4 py-3 rounded-xl border border-slate-700/50">
         <div class="flex items-center gap-3">
             <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
             <span class="text-sm font-medium text-slate-300">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="text-green-400">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span></span>
         </div>
         <button id="admin-logout-button" class="text-xs px-3 py-1.5 rounded border border-red-500/30 text-red-300 hover:bg-red-900/20 transition-colors">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 bg-slate-900/50 p-1.5 rounded-xl border border-slate-800">
            <button id="admin-tab-basic" class="py-2.5 rounded-lg text-sm font-medium bg-red-800/80 text-white shadow border border-red-700/50 transition-all">üìÇ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</button> 
            <button id="admin-tab-scan" class="py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition-all">üì∏ ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button id="admin-tab-check" class="py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition-all">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</button> 
            <button id="admin-tab-report" class="py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition-all">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô/Export</button>
        </div>

        <section id="admin-panel-basic" class="bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6 animate-fade-in">
          <div class="flex items-center gap-2 mb-2">
              <span class="text-2xl">üìÇ</span>
              <h3 class="text-lg font-bold text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
             <div class="space-y-4">
                 <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                    <form id="form-subject" class="flex gap-2 items-end">
                        <div class="flex-1"><label class="text-xs text-slate-400">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</label><input id="subject-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-red-500 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô ‡∏õ.5"></div>
                        <button type="submit" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded text-sm font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </form>
                 </div>
                 <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700">
                    <form id="form-class" class="flex gap-2 items-end">
                        <div class="flex-1"><label class="text-xs text-slate-400">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input id="class-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-red-500 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.5/1"></div>
                        <button type="submit" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded text-sm font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </form>
                 </div>
             </div>
             <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700 flex flex-col justify-between">
                <h4 class="text-sm font-semibold text-white mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                <form id="form-student" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á</label><select id="student-class" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none focus:border-red-500"></select></div>
                        <div><label class="text-xs text-slate-400">‡∏£‡∏´‡∏±‡∏™ Barcode</label><input id="student-id" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none focus:border-red-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 66001"></div>
                    </div>
                    <div><label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="student-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none focus:border-red-500"></div>
                    <button type="submit" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-2 rounded text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </form>
             </div>
          </div>
          <div class="bg-slate-800/60 p-5 rounded-xl border border-slate-700">
            <h4 class="text-sm font-bold text-red-300 mb-4 border-b border-slate-700 pb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö (Task Creation)</h4>
            <form id="form-task" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                <div class="md:col-span-2"><label class="text-xs text-slate-400">‡∏ß‡∏¥‡∏ä‡∏≤</label><select id="task-subject" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none focus:border-red-500"></select></div>
                <div class="md:col-span-2"><label class="text-xs text-slate-400">‡∏´‡πâ‡∏≠‡∏á</label><select id="task-class" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none focus:border-red-500"></select></div>
                <div class="md:col-span-2"><label class="text-xs text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Category)</label>
                    <select id="task-category" class="w-full bg-slate-900 border border-amber-500/50 text-amber-300 rounded px-2 py-2 text-xs outline-none font-semibold">
                        <option value="accum">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (60)</option>
                        <option value="midterm">üìù ‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</option>
                        <option value="final">üéì ‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</option>
                    </select>
                </div>
                <div class="md:col-span-4"><label class="text-xs text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input id="task-name" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none focus:border-red-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1"></div>
                <div class="md:col-span-1"><label class="text-xs text-slate-400">‡πÄ‡∏ï‡πá‡∏°</label><input id="task-max-score" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none text-center focus:border-red-500" value="10"></div>
                <div class="md:col-span-1"><button type="submit" class="w-full bg-red-700 hover:bg-red-600 text-white py-2 rounded text-xs font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á</button></div>
            </form>
            <div class="mt-4 bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                <p class="text-[10px] text-slate-400 mb-2">üìå QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î):</p>
                <ul id="task-list-qr" class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-amber-300"></ul>
            </div>
          </div>
        </section>

        <section id="admin-panel-scan" class="hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <span class="text-2xl">üì∏</span>
                <h3 class="text-lg font-bold text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
              </div>
              <div class="bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 flex items-center gap-3">
                 <div class="w-3 h-3 rounded-full bg-amber-500 animate-pulse" id="scan-indicator-light"></div>
                 <div>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Current Task</p>
                    <p id="current-task-display" class="text-sm font-bold text-amber-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Scan QR Task)</p>
                 </div>
              </div>
          </div>
          <div class="relative group">
             <div class="absolute -inset-1 bg-gradient-to-r from-red-600 to-amber-500 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
             <input id="scan-input" type="text" class="relative block w-full rounded-xl border-2 border-slate-700 bg-slate-900 text-white px-6 py-6 text-2xl text-center font-mono tracking-[0.2em] focus:outline-none focus:border-red-500 placeholder-slate-600 transition-all" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î" autocomplete="off">
          </div>
          <p id="scan-feedback" class="text-sm text-center text-slate-400 min-h-[1.5em] font-medium"></p>
        </section>

        <section id="admin-panel-check" class="hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üîç</span>
                <h3 class="text-lg font-bold text-white">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
            </div>
            <div class="flex flex-col md:flex-row gap-3 items-center bg-slate-800/60 p-4 rounded-xl border border-slate-700 shadow-inner">
                <input id="check-student-input" type="text" class="flex-1 w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 outline-none placeholder-slate-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">
                <button id="btn-check-student" class="bg-amber-600 hover:bg-amber-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-amber-500/20 transition-all">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            </div>
            <div id="check-result" class="hidden flex flex-col gap-5 animate-fade-in-up">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-red-900/50 shadow-xl flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-red-600/10 rounded-full blur-2xl"></div>
                    <div>
                        <p class="text-xs text-slate-400 uppercase tracking-widest mb-1">Student Profile</p>
                        <h2 id="check-name" class="text-2xl md:text-3xl font-bold text-white mb-1">-</h2>
                        <p id="check-class" class="text-amber-400 font-medium">-</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right">
                            <p class="text-xs text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</p>
                            <p id="check-total-score" class="text-xl font-bold text-white">0 <span class="text-sm text-slate-500">/ 100</span></p>
                        </div>
                        <div class="flex flex-col items-center">
                            <div id="check-grade-badge" class="w-16 h-16 flex items-center justify-center rounded-full bg-slate-700 text-2xl font-bold text-white shadow-inner border-4 border-slate-600">-</div>
                            <span class="text-[10px] text-slate-400 mt-1">‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>
                        </div>
                    </div>
                </div>
                <div class="overflow-hidden bg-slate-800/40 rounded-xl border border-slate-700">
                    <table class="min-w-full text-sm text-slate-300">
                        <thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400">
                            <tr>
                                <th class="px-4 py-3 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th class="px-4 py-3 text-left">‡∏á‡∏≤‡∏ô</th>
                                <th class="px-4 py-3 text-center">‡πÄ‡∏ï‡πá‡∏°</th>
                                <th class="px-4 py-3 text-right">‡πÑ‡∏î‡πâ</th>
                            </tr>
                        </thead>
                        <tbody id="check-table-body" class="divide-y divide-slate-700/50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="admin-panel-report" class="hidden bg-slate-800/20 border border-slate-700 rounded-2xl p-5 flex flex-col gap-6">
             <div class="flex items-center justify-between">
                 <div class="flex items-center gap-2">
                    <span class="text-2xl">üìä</span>
                    <h3 class="text-lg font-bold text-white">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏• (Report)</h3>
                 </div>
                 <button id="btn-export-csv" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-green-500/20 flex items-center gap-2 transition-all">
                    üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV
                 </button>
             </div>
             
             <div class="grid grid-cols-2 gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label>
                    <select id="report-subject" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none focus:border-red-500"></select>
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <select id="report-class" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none focus:border-red-500"></select>
                </div>
             </div>

             <div class="bg-slate-800/40 rounded-xl border border-slate-700 overflow-hidden">
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-slate-300">
                        <thead class="bg-slate-900 text-xs uppercase font-semibold text-slate-400">
                            <tr>
                                <th class="px-4 py-3 text-left whitespace-nowrap">‡∏£‡∏´‡∏±‡∏™</th>
                                <th class="px-4 py-3 text-left whitespace-nowrap">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="px-4 py-3 text-center whitespace-nowrap text-amber-500/80">‡πÄ‡∏Å‡πá‡∏ö (60)</th>
                                <th class="px-4 py-3 text-center whitespace-nowrap text-blue-400/80">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</th>
                                <th class="px-4 py-3 text-center whitespace-nowrap text-purple-400/80">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</th>
                                <th class="px-4 py-3 text-center whitespace-nowrap font-bold text-white">‡∏£‡∏ß‡∏° (100)</th>
                                <th class="px-4 py-3 text-center whitespace-nowrap text-white">‡πÄ‡∏Å‡∏£‡∏î</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-slate-700/50">
                            <tr>
                                <td colspan="7" class="px-4 py-6 text-center text-slate-500 italic">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                            </tr>
                        </tbody>
                    </table>
                 </div>
             </div>
        </section>

       </div>
      </section>

      <section id="panel-student" class="hidden flex flex-col gap-5 transition-all duration-500">
          <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-10 gap-6">
            <div class="text-center space-y-2">
                <div class="flex justify-center mb-5">
                    <img src="https://img5.pic.in.th/file/secure-sv1/-2c77ac97561c12fab.png" alt="Student Logo" class="w-28 h-28 object-contain drop-shadow-xl hover:scale-105 transition-transform bg-white/5 rounded-full p-2 border border-slate-700">
                </div>
                <h2 class="text-2xl font-bold text-white">üéì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <p class="text-slate-400 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            </div>
            <form id="student-login-form" class="w-full max-w-xs relative">
                <input id="student-login-id" type="text" class="w-full bg-slate-900/80 border-2 border-slate-700 rounded-xl px-5 py-4 text-center text-xl tracking-widest text-white focus:border-red-500 focus:ring-4 focus:ring-red-500/20 outline-none transition-all placeholder-slate-600" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                <button type="submit" class="w-full mt-4 bg-red-700 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
            <p id="student-login-error" class="text-sm text-red-400 font-medium min-h-[1.5em]"></p>
          </div>

          <div id="student-dashboard" class="hidden flex flex-col gap-6">
             <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 flex justify-between items-center shadow-lg">
                 <div>
                     <p class="text-xs text-slate-400 uppercase">Welcome back</p>
                     <h2 id="stu-name-display" class="text-xl md:text-2xl font-bold text-white">-</h2>
                     <p id="stu-class-display" class="text-sm text-amber-400">-</p>
                 </div>
                 <button id="btn-student-logout" class="px-4 py-2 border border-slate-600 text-slate-300 rounded-lg hover:bg-slate-700 text-xs font-bold transition-colors">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
             </div>
             <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                 <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center">
                     <p class="text-xs text-slate-400 mb-1">‡πÄ‡∏Å‡πá‡∏ö (60)</p>
                     <p id="stu-score-accum" class="text-xl font-bold text-white">-</p>
                 </div>
                 <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center">
                    <p class="text-xs text-slate-400 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</p>
                    <p id="stu-score-mid" class="text-xl font-bold text-white">-</p>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center">
                    <p class="text-xs text-slate-400 mb-1">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</p>
                    <p id="stu-score-final" class="text-xl font-bold text-white">-</p>
                </div>
                <div class="bg-gradient-to-br from-red-900 to-slate-900 p-4 rounded-xl border border-red-500/30 text-center relative overflow-hidden group">
                    <div class="absolute inset-0 bg-red-600/10 group-hover:bg-red-600/20 transition-all"></div>
                    <p class="text-xs text-red-200 mb-1 relative z-10">‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <p id="stu-grade-total" class="text-3xl font-bold text-white relative z-10">-</p>
                </div>
             </div>
             <div class="bg-slate-800/30 rounded-2xl border border-slate-700/50 overflow-hidden">
                 <div class="px-5 py-3 border-b border-slate-700/50 bg-slate-800/50">
                     <h3 class="text-sm font-bold text-white">üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</h3>
                 </div>
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-slate-300">
                        <thead class="bg-slate-900/50 text-xs uppercase text-slate-400">
                            <tr>
                                <th class="px-4 py-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="px-4 py-3 text-left">‡∏á‡∏≤‡∏ô</th>
                                <th class="px-4 py-3 text-center">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                                <th class="px-4 py-3 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody id="stu-task-body" class="divide-y divide-slate-700/30"></tbody>
                    </table>
                 </div>
                 <div class="px-4 py-3 bg-slate-900/30 flex justify-center gap-4 text-[10px] text-slate-500">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> ‡∏£‡∏≠‡∏™‡πà‡∏á</span>
                 </div>
             </div>
          </div>
      </section>

     </div>
    </main>

    <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-md transition-opacity">
        <div class="bg-slate-900 border border-slate-600 rounded-2xl p-6 w-full max-w-xs shadow-2xl transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-white mb-4 text-center border-b border-slate-700 pb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <div class="space-y-1 mb-4 text-sm">
                <p class="text-slate-400">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="modal-student-name" class="text-white font-semibold"></span></p>
                <p class="text-slate-400">‡∏á‡∏≤‡∏ô: <span id="modal-task-name" class="text-amber-400 font-semibold"></span></p>
            </div>
            <div class="relative">
                <input id="modal-score-input" type="number" class="w-full bg-slate-950 border-2 border-red-500 rounded-xl px-4 py-4 text-3xl text-center text-white font-bold focus:ring-4 focus:ring-red-500/30 focus:outline-none" placeholder="0">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm font-medium">/ <span id="modal-max-score">10</span></span>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button id="btn-modal-cancel" class="py-2.5 rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 font-medium text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-modal-save" class="py-2.5 rounded-lg bg-red-700 text-white hover:bg-red-600 font-bold text-sm shadow-lg shadow-red-500/20">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Enter)</button>
            </div>
        </div>
    </div>

   </div>
  </div>

  <script>
      // ‚ö†Ô∏è‚ö†Ô∏è URL Web App ‚ö†Ô∏è‚ö†Ô∏è
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec";

      let isAdminLoggedIn = false;
      let dataState = { subjects:[], classes:[], students:[], tasks:[], scores:[] };
      let currentScanTask = null;

      window.addEventListener('DOMContentLoaded', () => {
          syncData();
          initEventListeners();
      });

      async function syncData() {
          try {
             const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
             const json = await res.json();
             if(json) {
                 dataState = json;
                 refreshAdminUI();
             }
          } catch(e) { console.error("Sync Error", e); }
      }

      function refreshAdminUI() {
          const populate = (id, arr) => {
              const el = document.getElementById(id);
              el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
              arr.forEach(i => {
                  const opt = document.createElement('option');
                  opt.value = i.id;
                  opt.textContent = i.name;
                  el.appendChild(opt);
              });
          };

          populate('task-subject', dataState.subjects);
          populate('task-class', dataState.classes);
          populate('student-class', dataState.classes);
          populate('report-subject', dataState.subjects);
          populate('report-class', dataState.classes);

          const qrList = document.getElementById('task-list-qr');
          qrList.innerHTML = '';
          dataState.tasks.slice(-6).reverse().forEach(t => {
              const li = document.createElement('li');
              li.className = "bg-slate-900/50 p-2 rounded border border-slate-700/50 flex flex-col";
              li.innerHTML = `<span class="font-bold text-white">${t.name}</span> <span class="text-[10px] text-slate-400">QR: TASK:${t.id}</span>`;
              qrList.appendChild(li);
          });
      }

      function initEventListeners() {
          document.getElementById('tab-admin').addEventListener('click', () => toggleMainTab('admin'));
          document.getElementById('tab-student').addEventListener('click', () => toggleMainTab('student'));

          document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const u = document.getElementById('admin-username').value;
              const p = document.getElementById('admin-password').value;
              const status = document.getElementById('admin-login-status');
              status.textContent = "Checking...";
              try {
                  const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: u, password: p }) });
                  const json = await res.json();
                  if(json.status === 'success') {
                      isAdminLoggedIn = true;
                      document.getElementById('admin-login-section').classList.add('hidden');
                      document.getElementById('admin-content-section').classList.remove('hidden');
                      status.textContent = "";
                  } else { status.textContent = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; }
              } catch(err) { console.error(err); status.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"; }
          });
          document.getElementById('admin-logout-button').addEventListener('click', () => location.reload());

          ['basic', 'scan', 'check', 'report'].forEach(t => {
              document.getElementById(`admin-tab-${t}`).addEventListener('click', (e) => {
                  document.querySelectorAll('[id^="admin-tab-"]').forEach(b => { 
                      b.classList.remove('bg-red-800/80', 'text-white', 'shadow', 'border-red-700/50'); 
                      b.classList.add('text-slate-400'); 
                  });
                  e.target.classList.remove('text-slate-400'); 
                  e.target.classList.add('bg-red-800/80', 'text-white', 'shadow', 'border', 'border-red-700/50');
                  
                  document.querySelectorAll('[id^="admin-panel-"]').forEach(p => p.classList.add('hidden'));
                  document.getElementById(`admin-panel-${t}`).classList.remove('hidden');
                  
                  // Trigger Report Render if clicked
                  if(t === 'report') renderReportTable();
                  if(t === 'scan') document.getElementById('scan-input').focus();
              });
          });

          // Report Dropdown Listeners
          document.getElementById('report-class').addEventListener('change', renderReportTable);
          document.getElementById('report-subject').addEventListener('change', renderReportTable);

          setupFormSubmit('form-subject', 'addSubject', () => ({ id: Date.now(), name: document.getElementById('subject-name').value }));
          setupFormSubmit('form-class', 'addClass', () => ({ id: Date.now(), name: document.getElementById('class-name').value, subjectId: 0 }));
          setupFormSubmit('form-student', 'addStudent', () => ({ id: Date.now(), classId: document.getElementById('student-class').value, code: document.getElementById('student-id').value, name: document.getElementById('student-name').value, email: '' }));

          document.getElementById('form-task').addEventListener('submit', (e) => {
              e.preventDefault();
              const cat = document.getElementById('task-category').value;
              const max = Number(document.getElementById('task-max-score').value);
              const subj = document.getElementById('task-subject').value;
              const cls = document.getElementById('task-class').value;
              if(cat === 'accum') {
                  const currentAccum = dataState.tasks.filter(t => t.subjectId == subj && t.classId == cls && t.category === 'accum').reduce((sum, t) => sum + Number(t.maxScore), 0);
                  if(currentAccum + max > 60) { alert(`‚ö†Ô∏è ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏°‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô 60 (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentAccum})`); return; }
              }
              const payload = { action: 'addTask', id: Date.now(), name: document.getElementById('task-name').value, subjectId: subj, classId: cls, maxScore: max, category: cat, dueDateISO: new Date().toISOString() };
              saveAndRefresh(payload);
              document.getElementById('task-name').value = '';
              alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          });

          const scanInput = document.getElementById('scan-input');
          scanInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { handleScanInput(scanInput.value.trim()); scanInput.value = ''; } });
          scanInput.addEventListener('blur', () => { if(!document.getElementById('score-modal').classList.contains('hidden') === false) setTimeout(() => scanInput.focus(), 100); });

          document.getElementById('btn-modal-save').addEventListener('click', saveScoreFromModal);
          document.getElementById('btn-modal-cancel').addEventListener('click', closeScoreModal);
          document.getElementById('modal-score-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') saveScoreFromModal(); if(e.key === 'Escape') closeScoreModal(); });

          document.getElementById('btn-check-student').addEventListener('click', performCheckStudent);
          document.getElementById('check-student-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') performCheckStudent(); });
          document.getElementById('btn-export-csv').addEventListener('click', exportCSV);

          document.getElementById('student-login-form').addEventListener('submit', handleStudentLogin);
          document.getElementById('btn-student-logout').addEventListener('click', () => {
              document.getElementById('student-dashboard').classList.add('hidden');
              document.getElementById('student-login-wrapper').classList.remove('hidden');
              document.getElementById('student-login-id').value = '';
          });
      }

      function setupFormSubmit(formId, actionName, dataExtractor) {
          document.getElementById(formId).addEventListener('submit', (e) => {
              e.preventDefault();
              const payload = { action: actionName, ...dataExtractor() };
              saveAndRefresh(payload);
              e.target.reset();
          });
      }

      async function saveAndRefresh(payload) {
          if(payload.action === 'addSubject') dataState.subjects.push(payload);
          if(payload.action === 'addClass') dataState.classes.push(payload);
          if(payload.action === 'addStudent') dataState.students.push(payload);
          if(payload.action === 'addTask') dataState.tasks.push(payload);
          if(payload.action === 'addScore') {
              const idx = dataState.scores.findIndex(s => s.studentId == payload.studentId && s.taskId == payload.taskId);
              if(idx > -1) dataState.scores[idx].score = payload.score;
              else dataState.scores.push({ studentId: payload.studentId, taskId: payload.taskId, score: payload.score });
          }
          refreshAdminUI();
          await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      }

      function toggleMainTab(target) {
          const tabAdmin = document.getElementById('tab-admin');
          const tabStudent = document.getElementById('tab-student');
          const panAdmin = document.getElementById('panel-admin');
          const panStudent = document.getElementById('panel-student');
          if(target === 'admin') {
              tabAdmin.className = "px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all duration-300";
              tabStudent.className = "px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all duration-300";
              panAdmin.classList.remove('hidden'); panStudent.classList.add('hidden');
          } else {
              tabStudent.className = "px-5 py-2 rounded-full text-sm font-semibold text-white bg-red-700 shadow-lg transition-all duration-300";
              tabAdmin.className = "px-5 py-2 rounded-full text-sm font-semibold text-slate-400 hover:text-white hover:bg-slate-800 transition-all duration-300";
              panStudent.classList.remove('hidden'); panAdmin.classList.add('hidden');
          }
      }

      function handleScanInput(code) {
          if(!code) return;
          const statusEl = document.getElementById('scan-feedback');
          const indicator = document.getElementById('scan-indicator-light');
          
          if(code.toUpperCase().startsWith('TASK:')) {
              const tid = code.split(':')[1];
              const task = dataState.tasks.find(t => t.id == tid);
              if(task) {
                  currentScanTask = task;
                  document.getElementById('current-task-display').textContent = `${task.name} (${task.category})`;
                  document.getElementById('current-task-display').className = "text-sm font-bold text-amber-400";
                  indicator.className = "w-3 h-3 rounded-full bg-amber-500 shadow-[0_0_10px_#f59e0b]";
                  statusEl.textContent = "‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
                  statusEl.className = "text-sm text-center text-amber-400 min-h-[1.5em] font-medium";
              } else { statusEl.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"; statusEl.className = "text-sm text-center text-red-400 min-h-[1.5em] font-medium"; }
              return;
          }
          if(!currentScanTask) { statusEl.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô (TASK:...)"; statusEl.className = "text-sm text-center text-amber-400 min-h-[1.5em] font-medium"; return; }
          
          const student = dataState.students.find(s => s.code == code);
          if(student) { 
              // üî¥üî¥ CLASS VALIDATION üî¥üî¥
              if(String(student.classId) !== String(currentScanTask.classId)) {
                  statusEl.textContent = `‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏ô‡∏£.‡∏≠‡∏¢‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô)`;
                  statusEl.className = "text-sm text-center text-red-400 min-h-[1.5em] font-medium";
                  return;
              }
              openScoreModal(student); statusEl.textContent = ""; 
          } else { statusEl.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™: ${code}`; statusEl.className = "text-sm text-center text-red-400 min-h-[1.5em] font-medium"; }
      }

      function openScoreModal(student) {
          pendingStudent = student;
          const modal = document.getElementById('score-modal');
          const input = document.getElementById('modal-score-input');
          document.getElementById('modal-student-name').textContent = student.name;
          document.getElementById('modal-task-name').textContent = currentScanTask.name;
          document.getElementById('modal-max-score').textContent = currentScanTask.maxScore;
          const exist = dataState.scores.find(s => s.studentId == student.id && s.taskId == currentScanTask.id);
          input.value = exist ? exist.score : currentScanTask.maxScore;
          modal.classList.remove('hidden');
          setTimeout(() => { input.focus(); input.select(); }, 100);
      }

      function closeScoreModal() {
          document.getElementById('score-modal').classList.add('hidden');
          document.getElementById('scan-input').focus();
          pendingStudent = null;
      }

      function saveScoreFromModal() {
          const val = document.getElementById('modal-score-input').value;
          if(val === '') return;
          const payload = { action: 'addScore', studentId: pendingStudent.id, taskId: currentScanTask.id, score: val };
          saveAndRefresh(payload);
          document.getElementById('scan-feedback').textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${pendingStudent.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
          document.getElementById('scan-feedback').className = "text-sm text-center text-green-400 min-h-[1.5em] font-medium";
          closeScoreModal();
      }

      function renderReportTable() {
          const cid = document.getElementById('report-class').value;
          const sid = document.getElementById('report-subject').value;
          const tbody = document.getElementById('report-table-body');
          tbody.innerHTML = '';

          if(!cid || !sid) {
              tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-slate-500 italic">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
              return;
          }

          const students = dataState.students.filter(s => s.classId == cid);
          const tasks = dataState.tasks.filter(t => t.classId == cid && t.subjectId == sid);

          if(students.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-slate-500 italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>';
              return;
          }

          students.forEach(s => {
              // Calc Scores
              let accum = 0, mid = 0, final = 0, total = 0;
              tasks.forEach(t => {
                  const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                  const val = sc ? Number(sc.score) : 0;
                  if(t.category === 'accum') accum += val;
                  else if(t.category === 'midterm') mid += val;
                  else if(t.category === 'final') final += val;
                  total += val;
              });

              const grade = calculateGrade(total);
              const tr = document.createElement('tr');
              tr.innerHTML = `
                  <td class="px-4 py-3 text-slate-300 font-mono">${s.code}</td>
                  <td class="px-4 py-3 text-white font-medium">${s.name}</td>
                  <td class="px-4 py-3 text-center text-amber-400 font-medium">${accum}</td>
                  <td class="px-4 py-3 text-center text-blue-400 font-medium">${mid}</td>
                  <td class="px-4 py-3 text-center text-purple-400 font-medium">${final}</td>
                  <td class="px-4 py-3 text-center font-bold text-white">${total}</td>
                  <td class="px-4 py-3 text-center">
                    <span class="px-2 py-0.5 rounded text-xs font-bold ${total>=50?'bg-green-600 text-white':'bg-red-600 text-white'}">${grade}</span>
                  </td>
              `;
              tbody.appendChild(tr);
          });
      }

      function performCheckStudent() {
          const input = document.getElementById('check-student-input').value.trim();
          if(!input) return;
          const student = dataState.students.find(s => s.code == input || s.name.includes(input));
          if(!student) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"); return; }
          document.getElementById('check-result').classList.remove('hidden');
          document.getElementById('check-name').textContent = student.name;
          document.getElementById('check-class').textContent = dataState.classes.find(c => c.id == student.classId)?.name;
          const tasks = dataState.tasks.filter(t => t.classId == student.classId);
          let total = 0;
          const tbody = document.getElementById('check-table-body');
          tbody.innerHTML = '';
          tasks.forEach(t => {
             const s = dataState.scores.find(x => x.studentId == student.id && x.taskId == t.id);
             const score = s ? Number(s.score) : 0;
             total += score;
             let colorClass = "text-white";
             if(t.category === 'midterm') colorClass = score < 13 ? "text-red-400 font-bold" : "text-green-400 font-bold";
             const tr = document.createElement('tr');
             tr.innerHTML = `<td class="px-4 py-3 text-slate-400">${t.category}</td><td class="px-4 py-3 text-white">${t.name}</td><td class="px-4 py-3 text-center text-slate-500">${t.maxScore}</td><td class="px-4 py-3 text-right ${colorClass}">${s ? score : '-'}</td>`;
             tbody.appendChild(tr);
          });
          document.getElementById('check-total-score').innerHTML = `${total} <span class="text-sm text-slate-500">/ 100</span>`;
          const grade = calculateGrade(total);
          const badge = document.getElementById('check-grade-badge');
          badge.textContent = grade;
          if(total >= 80) badge.className = "w-16 h-16 flex items-center justify-center rounded-full bg-green-500 text-2xl font-bold text-white shadow-[0_0_15px_#22c55e] border-4 border-green-400";
          else if(total >= 50) badge.className = "w-16 h-16 flex items-center justify-center rounded-full bg-blue-500 text-2xl font-bold text-white shadow border-4 border-blue-400";
          else badge.className = "w-16 h-16 flex items-center justify-center rounded-full bg-red-500 text-2xl font-bold text-white shadow border-4 border-red-400";
      }

      function calculateGrade(score) {
          if(score >= 80) return "4";
          if(score >= 75) return "3.5";
          if(score >= 70) return "3";
          if(score >= 65) return "2.5";
          if(score >= 60) return "2";
          if(score >= 55) return "1.5";
          if(score >= 50) return "1";
          return "0";
      }

      function exportCSV() {
          const cid = document.getElementById('report-class').value;
          const sid = document.getElementById('report-subject').value;
          if(!cid || !sid) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"); return; }
          let csv = "\uFEFFStudent ID,Name,Accum 1,Accum 2,Accum 3,Accum 4,Accum 5,Accum 6,Midterm,Final,Total,Grade\n";
          const students = dataState.students.filter(s => s.classId == cid);
          const tasks = dataState.tasks.filter(t => t.classId == cid && t.subjectId == sid);
          const accumTasks = tasks.filter(t => t.category === 'accum').slice(0, 6);
          const midTask = tasks.find(t => t.category === 'midterm');
          const finalTask = tasks.find(t => t.category === 'final');
          students.forEach(s => {
              let row = [`"${s.code}"`, `"${s.name}"`];
              let total = 0;
              for(let i=0; i<6; i++) {
                  if(accumTasks[i]) {
                      const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == accumTasks[i].id);
                      const val = sc ? Number(sc.score) : 0;
                      total += val; row.push(val);
                  } else row.push("-");
              }
              let mVal = 0; if(midTask) { const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == midTask.id); mVal = sc ? Number(sc.score) : 0; } total += mVal; row.push(mVal);
              let fVal = 0; if(finalTask) { const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == finalTask.id); fVal = sc ? Number(sc.score) : 0; } total += fVal; row.push(fVal);
              row.push(total); row.push(calculateGrade(total));
              csv += row.join(",") + "\n";
          });
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url; link.download = "report.csv"; link.click();
      }

      function handleStudentLogin(e) {
          e.preventDefault();
          const code = document.getElementById('student-login-id').value.trim();
          const err = document.getElementById('student-login-error');
          const s = dataState.students.find(x => x.code == code);
          if(!s) { err.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"; return; }
          err.textContent = "";
          renderStudentDashboard(s);
      }

      function renderStudentDashboard(s) {
          document.getElementById('student-login-wrapper').classList.add('hidden');
          document.getElementById('student-dashboard').classList.remove('hidden');
          document.getElementById('stu-name-display').textContent = s.name;
          const cls = dataState.classes.find(c => c.id == s.classId);
          document.getElementById('stu-class-display').textContent = cls ? cls.name : "-";
          const tasks = dataState.tasks.filter(t => t.classId == s.classId);
          let accum=0, mid=0, final=0, total=0;
          const tbody = document.getElementById('stu-task-body');
          tbody.innerHTML = '';
          const today = new Date().toISOString().split('T')[0];
          tasks.forEach(t => {
              const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
              const val = sc ? Number(sc.score) : 0;
              const hasScore = !!sc;
              if(t.category === 'accum') accum += val;
              else if(t.category === 'midterm') mid += val;
              else if(t.category === 'final') final += val;
              total += val;
              let statusHTML = ''; let statusClass = '';
              if(hasScore) { statusHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-900/30 border border-green-500/50 text-green-400 text-[10px]">‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`; statusClass = "bg-green-900/10"; } 
              else if (t.dueDateISO && t.dueDateISO < today) { statusHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-900/30 border border-red-500/50 text-red-400 text-[10px]">üî¥ ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</span>`; statusClass = "bg-red-900/10"; } 
              else { statusHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-900/30 border border-yellow-500/50 text-yellow-400 text-[10px]">üü° ‡∏£‡∏≠‡∏™‡πà‡∏á</span>`; }
              const tr = document.createElement('tr');
              tr.className = `border-b border-slate-700/50 ${statusClass}`;
              tr.innerHTML = `<td class="px-4 py-3 whitespace-nowrap">${statusHTML}</td><td class="px-4 py-3 text-white"><div class="font-medium">${t.name}</div><div class="text-[10px] text-slate-500 uppercase">${t.category}</div></td><td class="px-4 py-3 text-center text-slate-400 text-xs">${t.dueDateISO ? t.dueDateISO.split('T')[0] : '-'}</td><td class="px-4 py-3 text-right font-mono text-indigo-300">${hasScore ? val : '-'}<span class="text-slate-600">/${t.maxScore}</span></td>`;
              tbody.appendChild(tr);
          });
          document.getElementById('stu-score-accum').textContent = accum;
          document.getElementById('stu-score-mid').textContent = mid;
          document.getElementById('stu-score-final').textContent = final;
          document.getElementById('stu-grade-total').textContent = calculateGrade(total);
      }
  </script>
 </body>
</html>
